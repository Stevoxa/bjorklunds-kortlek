<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Kortlek</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#344a34"> 
    <link rel="apple-touch-icon" href="icon-192x192.png"> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            /* Light Theme (Default) */
            --bg-color: #fdfcf7;
            --surface-bg-color: #fff;
            --text-color: #333;
            --secondary-text-color: #777;
            --primary-color: #344a34;
            --primary-color-rgb: 52, 74, 52;
            --primary-text-color: #f8f8f8;
            
            --secondary-button-bg-color: #f0ead6;
            --secondary-button-text-color: var(--primary-color);
            --secondary-button-border-color: var(--primary-color);
            
            --border-color: #ccc; 
            --subtle-border-color: #eee; 
            
            --danger-color: #c0392b;
            --danger-secondary-bg: #f8d7da; 
            --danger-secondary-text-color: #721c24; 
            
            --listening-color: #FFC107;
            --icon-fill-color: var(--primary-color); 
            --icon-hover-fill-color: #000;

            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.85); 
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);
        }

        body[data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #121212; 
            --surface-bg-color: #1e1e1e;  
            --text-color: #e0e0e0;
            --secondary-text-color: #a0a0a0;
            --primary-color: #76c776; 
            --primary-text-color: #121212; 
            
            --secondary-button-bg-color: #333; 
            --secondary-button-text-color: var(--text-color); 
            --secondary-button-border-color: #555; 
            
            --border-color: #3a3a3a; 
            --subtle-border-color: #2c2c2c; 
            
            --danger-color: #ff8a80; 
            --danger-secondary-bg: #5c2b2b; 
            --danger-secondary-text-color: #ffcdd2; 
            
            --listening-color: #FFEB3B; 
            --icon-fill-color: var(--text-color); 
            --icon-hover-fill-color: #fff;

            --overlay-bg-color: rgba(18, 18, 18, 0.9); 
            --overlay-content-bg: var(--surface-bg-color);
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);
        }

        body {
            font-family: 'Georgia', serif;
            margin: 0;
            padding: 15px;
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }
        body.overlay-open {
            overflow: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--surface-bg-color); 
            padding: 20px;
            padding-top: 50px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            position: relative; 
            transition: background-color 0.3s ease;
        }
        
        .app-header-actions-left {
            position: absolute;
            top: 10px;
            left: 10px;
            display: flex;
            z-index: 10;
        }

        .app-header-actions { 
            position: absolute;
            top: 10px; 
            right: 10px; 
            display: flex;
            gap: 0px; 
            z-index: 10;
        }
        
        .app-header-actions-left .icon-button,
        .app-header-actions .icon-button { 
            background-color: transparent !important; 
            border: none !important;    
            padding: 4px; 
            width: 28px;  
            height: 28px; 
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        .app-header-actions-left .icon-button svg,
        .app-header-actions .icon-button svg {
            fill: var(--icon-fill-color) !important; 
            width: 20px; 
            height: 20px;
        }
        .app-header-actions-left .icon-button:hover svg,
        .app-header-actions .icon-button:hover svg {
             fill: var(--icon-hover-fill-color) !important; 
         }

        h1 {
            color: var(--primary-color); 
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.7em; 
            margin-top: 0; 
        }
        h2 {
            color: var(--primary-color); 
            text-align: center; 
            margin-bottom: 10px; 
            font-size: 1.3em; 
            margin-top: 25px; 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 8px; 
            display: flex; 
            justify-content: center; 
            align-items: center;
            position: relative; 
        }
        
        .input-group {
            display: flex;
            margin-bottom: 15px;
            gap: 5px; 
            align-items: center; 
        }

        .input-group input[type="text"] {
            flex-grow: 1;
            flex-shrink: 1; 
            min-width: 100px; 
            padding: 10px;
            border: 1px solid var(--border-color); 
            border-radius: 4px;
            font-size: 1em;
            height: 40px; 
            box-sizing: border-box;
            background-color: var(--surface-bg-color); 
            color: var(--text-color); 
        }
        .input-group input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        .input-group input[type="text"]::-ms-input-placeholder { color: var(--secondary-text-color); } 

        button, .button-like { 
            padding: 10px 15px;
            background-color: var(--primary-color); 
            color: var(--primary-text-color); 
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Georgia', serif;
            transition: background-color 0.3s ease, fill 0.3s ease, border-color 0.3s ease, color 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            height: 40px; 
            box-sizing: border-box;
            flex-shrink: 0; 
        }
        
        button:hover, .button-like:hover { 
             background-color: color-mix(in srgb, var(--primary-color) 85%, black);
        }

        .button-secondary {
            background-color: var(--secondary-button-bg-color); 
            color: var(--secondary-button-text-color); 
            border: 1px solid var(--secondary-button-border-color); 
        }
        .button-secondary:hover {
            background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, #000000 10%); 
        }
        
        .icon-button { 
            padding: 8px;
            width: 40px; 
            height: 40px;
            min-width: 40px; 
            background-color: transparent; 
            border: none;
            flex-shrink: 0;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
        }
        #speakNameBtn.icon-button.button-secondary,
        #speakPassNameBtn.icon-button.button-secondary { 
             background-color: var(--secondary-button-bg-color); 
             border: 1px solid var(--secondary-button-border-color); 
        }
         #speakNameBtn.icon-button.button-secondary:hover,
         #speakPassNameBtn.icon-button.button-secondary:hover {
             background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, #000000 10%);
         }
         #speakNameBtn.icon-button.button-secondary svg,
         #speakPassNameBtn.icon-button.button-secondary svg { 
             fill: var(--secondary-button-text-color) !important; 
        }

        .icon-button:not(.app-header-actions-left .icon-button):not(.app-header-actions .icon-button):not(#speakNameBtn):not(#speakPassNameBtn):not(.settings-toggle-btn):not(.delete-btn) svg {
            width: 20px;
            height: 20px;
            fill: var(--primary-color); 
            transition: fill 0.3s ease;
        }
        .icon-button:not(.button-secondary):not(.app-header-actions-left .icon-button):not(.app-header-actions .icon-button):not(#speakNameBtn):not(#speakPassNameBtn):not(.settings-toggle-btn):not(.delete-btn):hover:not(:disabled) svg, 
        .overlay-header .icon-button:hover:not(:disabled) svg { 
            fill: var(--icon-hover-fill-color); 
        }

        .icon-button.is-listening svg { 
            fill: var(--listening-color) !important; 
        }
        .icon-button:disabled svg {
            fill: var(--secondary-text-color) !important;  
        }

        .settings-toggle-btn { 
            background-color: transparent !important; 
            border: none !important;
            padding: 0 5px 0 10px; 
        }
        .settings-toggle-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--primary-color) !important; 
            transition: transform 0.3s ease, fill 0.3s ease;
        }
        .settings-toggle-btn:hover svg {
            fill: var(--icon-hover-fill-color) !important;
        }
        .settings-toggle-btn.open svg {
            transform: rotate(90deg);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px; 
            flex-wrap: wrap; 
        }
         .action-buttons > button, 
         .action-buttons > .file-input-wrapper {
            font-size: 0.9em; 
            height: auto; 
            flex-basis: calc(50% - 5px); 
            min-width: 130px; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch; 
         }
         .action-buttons > button:not(#installAppBtn) { 
            padding: 8px 12px; 
            height: 38px; 
            align-items: center; 
            justify-content: center;
         }
         #installAppBtn svg { 
             fill: currentColor; 
             width:18px; height:18px; 
         }
         .action-buttons .file-input-wrapper .button-like { 
            width: 100%; 
            font-size: 1em; 
            padding: 8px 10px; 
            height: 38px;
         }
        
         .file-format-info {
            font-size: 0.8em;
            font-style: italic;
            color: var(--secondary-text-color); 
            text-align: center; 
            margin-top: 4px; 
            margin-bottom: 0; 
            padding: 0 5px; 
            line-height: 1.2; 
         }

        #nameList ul, #resultsList ul, #overlayResultsList ul, #customPassDisplayList ul { 
            list-style-type: none;
            padding: 0;
            margin: 0; 
        }

        #nameList li, #resultsList li, #overlayResultsList li, #customPassDisplayList li { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--subtle-border-color); 
            word-break: break-word; 
            color: var(--text-color); 
        }
        #resultsList li span:first-child, #overlayResultsList li span:first-child { 
            margin-right: 5px;
            font-weight: bold;
            color: var(--text-color); 
        }

        #nameList li:last-child, #resultsList li:last-child, 
        #overlayResultsList li:last-child, #customPassDisplayList li:last-child { 
            border-bottom: none;
        }

        .delete-btn { 
            background-color: transparent !important; 
            border: none !important;
        }
        .delete-btn svg {
            fill: var(--danger-color) !important; 
            width: 18px; 
            height: 18px;
            transition: fill 0.2s ease-in-out;
        }
        .delete-btn:hover svg {
            fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; 
        }

        hr {
            border: 0;
            height: 1px;
            background-color: var(--border-color); 
            margin: 20px 0; 
        }

        input[type="file"] { 
            position: absolute !important;
            left: -9999px !important;
            width: 1px !important;
            height: 1px !important;
            opacity: 0 !important;
            pointer-events: none !important;
            overflow: hidden !important; 
        }
        
        .info-text {
            color: var(--secondary-text-color); 
        }
        #customPassesInfo, #noResultsInfo, #noCustomPassesInfo, #participantsCountInfo { 
            font-size: inherit;
            line-height: inherit;
            text-align: center; 
            margin-top: 8px; 
        }
         #noCustomPassesInfo, #noNamesInfo { 
            padding: 10px 0; 
         }
         #customPassesInfo, #participantsCountInfo { 
            color: var(--primary-color); 
         }

        #advancedPassSettings {
            border: 1px solid var(--border-color); 
            background-color: color-mix(in srgb, var(--surface-bg-color) 95%, var(--bg-color)); 
            padding: 12px; 
            margin-top: 10px;
            margin-bottom: 15px; 
            display: none; 
        }
        #advancedPassSettings > p:first-of-type { 
            margin-top:0;
            margin-bottom: 10px; 
            font-size: 0.9em;
            text-align: center; 
        }
        #advancedPassSettings .action-buttons { 
            margin-top: 10px; 
        }
        #advancedPassSettings .action-buttons > button,
        #advancedPassSettings .action-buttons > .file-input-wrapper {
            flex-basis: 100%; 
            margin-bottom: 8px; 
        }
        @media (min-width: 480px) { 
            #advancedPassSettings .action-buttons > button,
            #advancedPassSettings .action-buttons > .file-input-wrapper {
                 flex-basis: calc(33.333% - 7px); 
                 min-width: 100px;
            }
             #advancedPassSettings .action-buttons > .file-input-wrapper {
                min-width: 120px; 
             }
        }

        #customPassesInfo {
            /* color: var(--primary-color); Redan satt ovan */
            margin-top: 15px; 
            /* text-align: center; Redan satt ovan */
        }
        #unassignedParticipantsList {
            color: var(--danger-color); 
        }
        #unassignedParticipantsList strong {
            color: var(--text-color); 
        }

        .content-overlay, #resultOverlay {
            background-color: var(--overlay-bg-color); 
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 15px; 
            box-sizing: border-box;
        }

        .overlay-content-box {
            background-color: var(--overlay-content-bg); 
            padding: 20px; 
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            max-width: 550px; 
            width: 100%;
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
        }
        
        .overlay-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .overlay-header h3 {
            color: var(--overlay-header-text-color); 
            text-align: left; 
            margin: 0; 
            font-size: 1.6em;
            flex-grow: 1; 
        }
        .overlay-header .icon-button { 
            background-color: transparent !important;
            border: none !important;
            width: 30px;  
            height: 30px;
            padding: 5px;
        }
        .overlay-header .icon-button svg { 
            fill: var(--icon-fill-color) !important; 
            width: 18px;
            height: 18px;
        }
        .overlay-header .icon-button:hover svg {
            fill: var(--icon-hover-fill-color) !important;
        }

        .overlay-scrollable-content, .overlay-results-list-container {
             color: var(--overlay-text-color); 
             overflow-y: auto; 
             flex-grow: 1; 
             margin-bottom: 20px; 
             padding-right: 5px; 
        }
        .overlay-results-list-container {
            border: 1px solid var(--border-color); 
            padding: 10px;
            border-radius: 4px;
        }

        .overlay-scrollable-content h4 {
            color: var(--overlay-header-text-color); 
            border-bottom: 1px solid var(--border-color); 
            margin-top: 20px;
            margin-bottom: 8px;
            padding-bottom: 5px;
        }
        .overlay-scrollable-content h4:first-child {
            margin-top: 0;
        }
        .overlay-scrollable-content h5 {
            color: var(--overlay-text-color); 
            margin-top: 15px;
            margin-bottom: 5px;
        }
        .overlay-scrollable-content p, .overlay-scrollable-content ol {
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        .overlay-scrollable-content ol {
            padding-left: 20px;
        }
        .overlay-scrollable-content li { 
            margin-bottom: 5px;
            border-bottom: none; 
        }

        #qrCodeContainer {
            border:1px solid var(--border-color); 
            background:white; 
            margin: 20px auto; 
            width: 200px; 
            height: 200px; 
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        #qrCodeContainer canvas { 
            display: block;
        }

        #shareableLink {
            color: var(--overlay-link-color); 
        }
        
        .result-actions-top {
            display: none; 
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 8px; 
            gap: 0px; 
        }
        .result-actions-top .icon-button {
            padding: 6px; 
            width: 34px;
            height: 34px;
        }
        .result-actions-top .icon-button svg {
            width: 20px;
            height: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header-actions-left">
            <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;">
                    <path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/>
                </svg>
                <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;">
                    <path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
                </svg>
            </button>
        </div>

        <div class="app-header-actions">
            <button id="helpBtn" class="icon-button" title="Hjälp">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg>
            </button>
            <button id="shareBtn" class="icon-button" title="Dela appen">
                <svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg>
            </button>
            <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;">
                <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
            </button>
        </div>

        <h1>Björklunds Kortlek</h1>

        <div class="input-group">
            <input type="text" id="nameInput" placeholder="Ange passkytt...">
            <button id="addNameBtn">Lägg till</button>
            <button id="speakNameBtn" class="icon-button button-secondary" title="Tala in passkytt">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg>
            </button>
        </div>
        
        <div class="action-buttons">
            <div class="file-input-wrapper">
                <label for="fileInput" class="button-like button-secondary">Läs in passkyttar</label>
                <input type="file" id="fileInput" accept=".txt">
                <p class="file-format-info">Förväntat filformat: .txt (en passkytt per rad)</p>
            </div>
            <button id="saveNamesBtn" class="button-secondary">Spara passkyttlista</button>
        </div>

        <section id="nameListSection">
            <h2>Passkyttar (A-Ö)</h2>
            <ul id="nameList"></ul>
            <p id="participantsCountInfo" class="info-text"></p>
            <p id="noNamesInfo" class="info-text" style="display: none;">Inga passkyttar tillagda.</p>
        </section>

        <hr>
        
        <section id="resultsSection">
            <h2>
                <span id="passDistributionTitle">Passfördelning (1-n)</span>
                <button id="toggleAdvancedPassBtn" class="settings-toggle-btn" title="Avancerad">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                </button>
            </h2>
            <div id="advancedPassSettings" style="display: none;">
                <p>Använd en egen lista med passnamn/nummer istället för standardnumrering 1-n.</p>
                
                <div class="input-group" id="passInputGroup">
                    <input type="text" id="passNameInput" placeholder="Ange pass-ID...">
                    <button id="addPassNameBtn">Lägg till pass</button>
                    <button id="speakPassNameBtn" class="icon-button button-secondary" title="Tala in pass-ID">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg>
                    </button>
                </div>

                <div class="action-buttons"> 
                    <div class="file-input-wrapper">
                        <label for="passFileInput" class="button-like button-secondary">Läs in pass från fil</label>
                        <input type="file" id="passFileInput" accept=".txt">
                        <p class="file-format-info">Förväntat filformat: .txt (ett pass-ID per rad)</p>
                    </div>
                    <button id="savePassListBtn" class="button-secondary">Spara passlista</button>
                    <button id="clearCustomPassesBtn" class="button-secondary">Rensa hela listan</button> 
                </div>

                <section id="customPassListSection" style="margin-bottom: 15px; margin-top: 15px;"> 
                    <ul id="customPassDisplayList"></ul> 
                    <p id="noCustomPassesInfo" class="info-text" style="display: none;">Inga egna pass tillagda.</p>
                </section>
                
                <p id="customPassesInfo" class="info-text"></p> 
            </div>

            <div class="result-actions-top" id="mainResultActionsTop">
                <button id="reopenOverlayBtn" class="icon-button" title="Visa resultat i helskärm">
                    <svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                </button>
                <button id="mainCopyBtn" class="icon-button" title="Kopiera resultat">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </button>
            </div>

            <ul id="resultsList"></ul>
            <p id="unassignedParticipantsList" class="info-text" style="display:none;"></p>
            <p id="noResultsInfo" class="info-text">Klicka på "Slumpa Pass" för att se resultat.</p>
        </section>

        <button id="randomizeBtn" style="width: 100%; margin-top: 20px; padding: 15px; font-size: 1.2em;">Slumpa Pass</button>
    </div>

    <div id="resultOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Slumpat Resultat</h3>
                <button id="overlayCopyBtn" class="icon-button" title="Kopiera resultat" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                </button>
            </div>
            <div class="overlay-results-list-container">
                <ul id="overlayResultsList"></ul>
            </div>
            <p id="overlayUnassignedParticipants" class="info-text" style="display:none; margin-bottom: 15px;"></p>
            <button id="resultOverlayCloseBtn" class="overlay-close-btn">Stäng</button>
        </div>
    </div>

    <div id="helpOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Hjälp & Information</h3>
            </div>
            <div class="overlay-scrollable-content">
                <h4>Installera Appen på Din Hemskärm</h4>
                <p>För enklare åtkomst kan du lägga till Björklunds Kortlek på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>
                
                <h5>Android (t.ex. Chrome):</h5>
                <ol>
                    <li>Öppna appen i din Chrome-webbläsare.</li>
                    <li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li>
                    <li>Välj "Installera appen" eller "Lägg till på startskärmen".</li>
                    <li>Följ instruktionerna.</li>
                </ol>
                <p><em>Alternativt kan en "Installera App"-knapp ( <svg style="display:inline-block;width:1em;height:1em;vertical-align:-0.125em;" viewBox="0 0 24 24"><path fill="currentColor" d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> ) dyka upp automatiskt högst upp i appen när du använt sidan ett tag.</em></p>

                <h5>iOS (iPhone/iPad - Safari):</h5>
                <ol>
                    <li>Öppna appen i Safari-webbläsaren.</li>
                    <li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt) längst ner (eller uppe) i webbläsaren.</li>
                    <li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li>
                    <li>Bekräfta namnet och tryck "Lägg till".</li>
                </ol>
                
                <h4>Grundläggande Användning</h4>
                <p><strong>1. Lägg till Passkyttar:</strong> Skriv namn i fältet och klicka "Lägg till" eller tala in namn med mikrofonikonen. Antalet tillagda passkyttar visas under listan.</p>
                <p><strong>2. (Avancerat) Anpassad Passlista:</strong> Klicka på kugghjulet bredvid "Passfördelning". Du kan sedan mata in pass-ID manuellt (och tala in dem), ladda in en egen lista med passnamn/nummer från en .txt-fil (ett pass-ID per rad), eller spara den aktuella passlistan. Den tillagda passlistan visas och enskilda pass kan tas bort med minus-ikonen. En summering av antalet tillagda pass visas också.</p>
                <p><strong>3. Slumpa Pass:</strong> Klicka på den stora "Slumpa Pass"-knappen. Resultatet visas både i huvudvyn och i ett helskärmsläge.</p>
                <p><strong>4. Återöppna Resultat:</strong> Använd ögon-ikonen ovanför resultatlistan i huvudvyn för att återöppna helskärmsresultatet.</p>
                <p><strong>5. Kopiera/Dela:</strong> Använd kopieringsikonen för att kopiera resultatlistan. Använd dela-ikonen högst upp för att dela en länk till appen via en QR-kod.</p>
            </div>
            <button id="helpOverlayCloseBtn" class="overlay-close-btn">Stäng</button>
        </div>
    </div>

    <div id="shareOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Dela Björklunds Kortlek</h3>
            </div>
            <div class="overlay-scrollable-content" style="text-align: center;">
                <p>Skanna QR-koden nedan med en annan enhet, eller dela länken:</p>
                <div id="qrCodeContainer">
                    <!-- QR-kod kommer här -->
                </div>
                <p style="word-break: break-all;"><strong>Länk:</strong> <a id="shareableLink" href="https://stevoxa.github.io/bjorklunds-kortlek/" target="_blank" rel="noopener noreferrer">https://stevoxa.github.io/bjorklunds-kortlek/</a></p>
            </div>
            <button id="shareOverlayCloseBtn" class="overlay-close-btn">Stäng</button>
        </div>
    </div>

    <script>
        // --- DOM ELEMENT REFERENSER (definieras globalt) ---
        let themeToggleBtn, themeIconSun, themeIconMoon, nameInput, addNameBtn, nameList,
            randomizeBtn, resultsList, fileInput, saveNamesBtn, noNamesInfo, noResultsInfo,
            speakNameBtn, unassignedParticipantsList, toggleAdvancedPassBtn, advancedPassSettings,
            passFileInput, savePassListBtn, clearCustomPassesBtn, customPassesInfo,
            passDistributionTitle, resultOverlay, overlayResultsList, resultOverlayCloseBtn,
            overlayUnassignedParticipants, mainResultActionsTop, reopenOverlayBtn, mainCopyBtn,
            overlayCopyBtn, helpBtn, shareBtn, helpOverlay, helpOverlayCloseBtn, shareOverlay,
            shareOverlayCloseBtn, qrCodeContainer, shareableLink, installAppBtn,
            passNameInput, addPassNameBtn, speakPassNameBtn, 
            customPassDisplayList, noCustomPassesInfo,
            participantsCountInfo;

        // --- GLOBALA VARIABLER ---
        let participants = [];
        let customPasses = [];
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = "https://stevoxa.github.io/bjorklunds-kortlek/"; 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition; 
        let passRecognition;  

        // --- INITIERING VID LADDNING AV SIDAN ---
        document.addEventListener('DOMContentLoaded', () => {
            themeToggleBtn = document.getElementById('themeToggleBtn');
            themeIconSun = document.getElementById('themeIconSun');
            themeIconMoon = document.getElementById('themeIconMoon');
            nameInput = document.getElementById('nameInput');
            addNameBtn = document.getElementById('addNameBtn');
            nameList = document.getElementById('nameList');
            randomizeBtn = document.getElementById('randomizeBtn');
            resultsList = document.getElementById('resultsList');
            fileInput = document.getElementById('fileInput');
            saveNamesBtn = document.getElementById('saveNamesBtn');
            noNamesInfo = document.getElementById('noNamesInfo');
            noResultsInfo = document.getElementById('noResultsInfo');
            speakNameBtn = document.getElementById('speakNameBtn');
            unassignedParticipantsList = document.getElementById('unassignedParticipantsList');
            toggleAdvancedPassBtn = document.getElementById('toggleAdvancedPassBtn');
            advancedPassSettings = document.getElementById('advancedPassSettings');
            passFileInput = document.getElementById('passFileInput');
            savePassListBtn = document.getElementById('savePassListBtn');
            clearCustomPassesBtn = document.getElementById('clearCustomPassesBtn');
            customPassesInfo = document.getElementById('customPassesInfo');
            passDistributionTitle = document.getElementById('passDistributionTitle');
            resultOverlay = document.getElementById('resultOverlay');
            overlayResultsList = document.getElementById('overlayResultsList');
            resultOverlayCloseBtn = document.getElementById('resultOverlayCloseBtn'); 
            overlayUnassignedParticipants = document.getElementById('overlayUnassignedParticipants');
            mainResultActionsTop = document.getElementById('mainResultActionsTop');
            reopenOverlayBtn = document.getElementById('reopenOverlayBtn');
            mainCopyBtn = document.getElementById('mainCopyBtn'); 
            overlayCopyBtn = document.getElementById('overlayCopyBtn');
            helpBtn = document.getElementById('helpBtn');
            shareBtn = document.getElementById('shareBtn');
            helpOverlay = document.getElementById('helpOverlay');
            helpOverlayCloseBtn = document.getElementById('helpOverlayCloseBtn');
            shareOverlay = document.getElementById('shareOverlay');
            shareOverlayCloseBtn = document.getElementById('shareOverlayCloseBtn');
            qrCodeContainer = document.getElementById('qrCodeContainer');
            shareableLink = document.getElementById('shareableLink');
            installAppBtn = document.getElementById('installAppBtn');
            passNameInput = document.getElementById('passNameInput'); 
            addPassNameBtn = document.getElementById('addPassNameBtn'); 
            speakPassNameBtn = document.getElementById('speakPassNameBtn'); 
            customPassDisplayList = document.getElementById('customPassDisplayList');
            noCustomPassesInfo = document.getElementById('noCustomPassesInfo');
            participantsCountInfo = document.getElementById('participantsCountInfo');

            if (resultOverlay) resultOverlay.style.display = 'none';
            if (helpOverlay) helpOverlay.style.display = 'none';
            if (shareOverlay) shareOverlay.style.display = 'none';
            if (installAppBtn) installAppBtn.style.display = 'none'; 
            if (mainResultActionsTop) mainResultActionsTop.style.display = 'none';
            if (overlayCopyBtn) overlayCopyBtn.style.display = 'none';
            if (advancedPassSettings) advancedPassSettings.style.display = 'none';
            if (participantsCountInfo) participantsCountInfo.style.display = 'none';

            document.body.classList.remove('overlay-open'); 
            
            applyTheme(currentTheme); 
            renderNameList(); 
            updateCustomPassesUI();

            if (addNameBtn) addNameBtn.addEventListener('click', addName);
            if (nameInput) nameInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') addName(); });
            if (randomizeBtn) randomizeBtn.addEventListener('click', randomizePasses);
            if (fileInput) fileInput.addEventListener('change', loadParticipantNamesFromFile);
            if (saveNamesBtn) saveNamesBtn.addEventListener('click', saveParticipantNamesToFile);
            if (toggleAdvancedPassBtn) toggleAdvancedPassBtn.addEventListener('click', toggleAdvancedPassSettings);
            if (passFileInput) passFileInput.addEventListener('change', loadCustomPassesFromFile);
            if (savePassListBtn) savePassListBtn.addEventListener('click', saveCustomPassesToFile);
            if (clearCustomPassesBtn) clearCustomPassesBtn.addEventListener('click', clearLoadedCustomPasses);
            if (resultOverlayCloseBtn) resultOverlayCloseBtn.addEventListener('click', closeResultOverlay);
            if (helpOverlayCloseBtn) helpOverlayCloseBtn.addEventListener('click', closeHelpOverlay);
            if (shareOverlayCloseBtn) shareOverlayCloseBtn.addEventListener('click', closeShareOverlay);
            if (reopenOverlayBtn) reopenOverlayBtn.addEventListener('click', showResultOverlay);
            if (mainCopyBtn) mainCopyBtn.addEventListener('click', copyResultsToClipboard);
            if (overlayCopyBtn) overlayCopyBtn.addEventListener('click', copyResultsToClipboard);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            if (addPassNameBtn) addPassNameBtn.addEventListener('click', addPassManually); 
            if (passNameInput) passNameInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') addPassManually(); }); 
            
            setupSpeechRecognition();
            setupPassSpeechRecognition(); 
            setupPWAInstallation();
        });

        function setupSpeechRecognition() {
            if (SpeechRecognition && speakNameBtn) {
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
                    console.warn("Web Speech API (microphone access) requires HTTPS or localhost.");
                }
                try {
                    recognition = new SpeechRecognition();
                    recognition.lang = 'sv-SE';
                    recognition.continuous = false;
                    recognition.interimResults = false;
                    recognition.onresult = (event) => { 
                        const spokenName = event.results[0][0].transcript.trim();
                        if (addNameToParticipantsList(spokenName)) renderNameList(); 
                    };
                    recognition.onerror = (event) => {
                        console.error('Fel vid namn-röstigenkänning:', event.error, event.message);
                        if (speakNameBtn) {
                            speakNameBtn.title = "Fel vid röstinmatning"; 
                            speakNameBtn.classList.remove('is-listening'); 
                            speakNameBtn.disabled = false;
                        }
                    };
                    recognition.onstart = () => { 
                        if (speakNameBtn) {
                            speakNameBtn.classList.add('is-listening'); 
                            speakNameBtn.disabled = true; 
                            speakNameBtn.title = "Lyssnar (passkytt)..."; 
                        }
                    };
                    recognition.onend = () => { 
                        if (speakNameBtn) {
                            speakNameBtn.classList.remove('is-listening'); 
                            speakNameBtn.disabled = false; 
                            speakNameBtn.title = "Tala in passkytt"; 
                        }
                    };
                    speakNameBtn.addEventListener('click', () => { 
                        try { 
                            if (recognition) recognition.start(); 
                            else console.error("Namn-röstigenkänning är inte korrekt initierad.");
                        } catch (e) { 
                            console.error("Kunde inte starta namn-röstigenkänning (catch): ", e);
                            if (speakNameBtn) {
                                speakNameBtn.classList.remove('is-listening'); 
                                speakNameBtn.disabled = false; 
                                speakNameBtn.title = "Tala in passkytt";
                            }
                        }
                    });
                } catch (e) { 
                    console.error("Kunde inte initiera namn-SpeechRecognition objektet:", e);
                    if (speakNameBtn) { speakNameBtn.disabled = true; speakNameBtn.title = 'Röstigenkänning för passkyttar misslyckades.'; }
                }
            } else { 
                if (speakNameBtn) { speakNameBtn.disabled = true; speakNameBtn.title = 'Röstinmatning för passkyttar stöds ej.'; }
            }
        }

        function setupPassSpeechRecognition() { 
            if (SpeechRecognition && speakPassNameBtn) {
                try {
                    passRecognition = new SpeechRecognition();
                    passRecognition.lang = 'sv-SE'; 
                    passRecognition.continuous = false;
                    passRecognition.interimResults = false;
                    passRecognition.onresult = (event) => { 
                        const spokenPassId = event.results[0][0].transcript.trim();
                        addPassNameToList(spokenPassId);
                    };
                    passRecognition.onerror = (event) => {
                        console.error('Fel vid pass-röstigenkänning:', event.error, event.message);
                        if (speakPassNameBtn) {
                            speakPassNameBtn.title = "Fel vid pass-röstinmatning"; 
                            speakPassNameBtn.classList.remove('is-listening'); 
                            speakPassNameBtn.disabled = false;
                        }
                    };
                    passRecognition.onstart = () => { 
                        if (speakPassNameBtn) {
                            speakPassNameBtn.classList.add('is-listening'); 
                            speakPassNameBtn.disabled = true; 
                            speakPassNameBtn.title = "Lyssnar (pass)..."; 
                        }
                    };
                    passRecognition.onend = () => { 
                        if (speakPassNameBtn) {
                            speakPassNameBtn.classList.remove('is-listening'); 
                            speakPassNameBtn.disabled = false; 
                            speakPassNameBtn.title = "Tala in pass-ID"; 
                        }
                    };
                    speakPassNameBtn.addEventListener('click', () => { 
                        try { 
                            if (passRecognition) passRecognition.start(); 
                            else console.error("Pass-röstigenkänning är inte korrekt initierad.");
                        } catch (e) { 
                            console.error("Kunde inte starta pass-röstigenkänning (catch): ", e);
                            if (speakPassNameBtn) {
                                speakPassNameBtn.classList.remove('is-listening'); 
                                speakPassNameBtn.disabled = false; 
                                speakPassNameBtn.title = "Tala in pass-ID";
                            }
                        }
                    });
                } catch (e) { 
                    console.error("Kunde inte initiera pass-SpeechRecognition objektet:", e);
                    if (speakPassNameBtn) { speakPassNameBtn.disabled = true; speakPassNameBtn.title = 'Pass-röstigenkänning initiering misslyckades.'; }
                }
            } else { 
                if (speakPassNameBtn) { speakPassNameBtn.disabled = true; speakPassNameBtn.title = 'Pass-röstinmatning stöds ej.'; }
            }
        }

        function setupPWAInstallation() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                if (installAppBtn) {
                    installAppBtn.style.display = 'inline-flex';
                    const newInstallBtn = installAppBtn.cloneNode(true); 
                    if (installAppBtn.parentNode) {
                        installAppBtn.parentNode.replaceChild(newInstallBtn, installAppBtn);
                    }
                    installAppBtn = newInstallBtn;
                    installAppBtn.addEventListener('click', async () => { 
                        if (deferredPrompt) {
                            deferredPrompt.prompt();
                            await deferredPrompt.userChoice; 
                            deferredPrompt = null;
                            if (installAppBtn) installAppBtn.style.display = 'none';
                        } else { 
                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                            if (isIOS) {
                                alert("För att installera appen på din iPhone/iPad:\n1. Klicka på Dela-ikonen i Safari.\n2. Skrolla ner och välj 'Lägg till på hemskärmen'.");
                            } else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) {
                                alert("Appen är redan installerad!");
                            } else {
                                alert("Installationsprompten är inte tillgänglig. På iOS, använd 'Dela' -> 'Lägg till på hemskärmen'.");
                            }
                        }
                    });
                }
            });
            window.addEventListener('appinstalled', () => {
                if (installAppBtn) installAppBtn.style.display = 'none';
                deferredPrompt = null;
            });
        }

        // --- TEMA HANTERING ---
        function applyTheme(theme) {
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme);
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none';
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none';
            localStorage.setItem('theme', newTheme);
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Växla till ljust tema" : "Växla till mörkt tema";
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) {
                let colorForMeta;
                const rootStyle = getComputedStyle(document.documentElement); 
                if (newTheme === 'dark') {
                     colorForMeta = rootStyle.getPropertyValue('--primary-color').trim() || '#76c776';
                } else {
                     colorForMeta = rootStyle.getPropertyValue('--primary-color').trim() || '#344a34';
                }
                metaThemeColor.setAttribute("content", colorForMeta);
            }
        }
        function toggleTheme() {
            currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            applyTheme(currentTheme);
        }
        
        // --- KÄRNFUNKTIONER ---
        function smartSortPasses(a, b) {
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            const aIsNumber = !isNaN(numA) && isFinite(a);
            const bIsNumber = !isNaN(numB) && isFinite(b);

            if (aIsNumber && bIsNumber) {
                return numA - numB; 
            } else if (aIsNumber && !bIsNumber) {
                return -1; 
            } else if (!aIsNumber && bIsNumber) {
                return 1; 
            } else {
                return a.localeCompare(b, 'sv', { numeric: true, sensitivity: 'base' });
            }
        }

        function addNameToParticipantsList(nameToAdd) {
            const name = nameToAdd.trim();
            if (!name) { return false; }
            const nameLower = name.toLowerCase();
            if (participants.some(existingName => existingName.toLowerCase() === nameLower)) {
                alert('Passkytten "' + name + '" finns redan i listan.');
                return false;
            }
            participants.push(name); return true;
        }

        function addPassNameToList(passIdToAdd) {
            const passId = passIdToAdd.trim();
            if (!passId) { return false; }
            const passIdLower = passId.toLowerCase(); 
            if (customPasses.some(existingPass => existingPass.toLowerCase() === passIdLower)) {
                alert('Pass-ID "' + passId + '" (eller en variant) finns redan i listan.');
                return false;
            }
            customPasses.push(passId); 
            customPasses.sort(smartSortPasses); 
            updateCustomPassesUI(); 
            return true;
        }

        function addPassManually() { 
            if (passNameInput && addPassNameToList(passNameInput.value.trim())) {
                passNameInput.value = '';
            }
            if (passNameInput) passNameInput.focus();
        }

        function updateParticipantsCount() {
            if (participantsCountInfo) {
                if (participants.length > 0) {
                    participantsCountInfo.textContent = `(${participants.length} passkyttar tillagda)`;
                    participantsCountInfo.style.display = 'block';
                } else {
                    participantsCountInfo.style.display = 'none';
                }
            }
        }

        function renderNameList() {
            if (!nameList || !noNamesInfo) return;
            nameList.innerHTML = '';
            participants.sort((a, b) => a.localeCompare(b, 'sv', { sensitivity: 'base' }));
            noNamesInfo.style.display = participants.length === 0 ? 'block' : 'none';
            
            participants.forEach((name) => {
                const li = document.createElement('li'); li.textContent = name;
                const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-btn');
                deleteBtn.setAttribute('aria-label', 'Ta bort ' + name); deleteBtn.title = 'Ta bort ' + name;
                const svgNS = "http://www.w3.org/2000/svg"; const svgIcon = document.createElementNS(svgNS, "svg");
                svgIcon.setAttributeNS(null, "viewBox", "0 0 24 24");
                const p1 = document.createElementNS(svgNS, "path"); p1.setAttributeNS(null, "d", "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z");
                const p2 = document.createElementNS(svgNS, "path"); p2.setAttributeNS(null, "d", "M17 11H7v2h10v-2z");
                svgIcon.appendChild(p1); svgIcon.appendChild(p2); deleteBtn.appendChild(svgIcon);
                deleteBtn.onclick = () => deleteNameByValue(name); li.appendChild(deleteBtn); nameList.appendChild(li);
            });
            updateParticipantsCount();
        }

        function renderCustomPassList() {
            if (!customPassDisplayList || !noCustomPassesInfo) return;
            customPassDisplayList.innerHTML = '';
            noCustomPassesInfo.style.display = customPasses.length === 0 ? 'block' : 'none';

            customPasses.forEach((passId) => {
                const li = document.createElement('li');
                li.textContent = passId;
                const deleteBtn = document.createElement('button');
                deleteBtn.classList.add('delete-btn');
                deleteBtn.setAttribute('aria-label', 'Ta bort pass ' + passId);
                deleteBtn.title = 'Ta bort pass ' + passId;
                const svgNS = "http://www.w3.org/2000/svg"; const svgIcon = document.createElementNS(svgNS, "svg");
                svgIcon.setAttributeNS(null, "viewBox", "0 0 24 24");
                const p1 = document.createElementNS(svgNS, "path"); p1.setAttributeNS(null, "d", "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z");
                const p2 = document.createElementNS(svgNS, "path"); p2.setAttributeNS(null, "d", "M17 11H7v2h10v-2z");
                svgIcon.appendChild(p1); svgIcon.appendChild(p2); deleteBtn.appendChild(svgIcon);
                deleteBtn.onclick = () => deleteCustomPassByValue(passId); 
                li.appendChild(deleteBtn);
                customPassDisplayList.appendChild(li);
            });
            updateCustomPassesSummary();
        }

        function deleteCustomPassByValue(passIdToDelete) {
            const idx = customPasses.indexOf(passIdToDelete);
            if (idx > -1) {
                customPasses.splice(idx, 1);
                updateCustomPassesUI(); 
            }
        }
        
        function deleteNameByValue(nameToDelete) {
            const idx = participants.indexOf(nameToDelete);
            if (idx > -1) { participants.splice(idx, 1); renderNameList(); clearResults(); }
        }

        function clearResults() {
            if (resultsList) resultsList.innerHTML = '';
            if (overlayResultsList) overlayResultsList.innerHTML = '';
            if (noResultsInfo) noResultsInfo.style.display = 'block';
            if (unassignedParticipantsList) unassignedParticipantsList.style.display = 'none';
            if (overlayUnassignedParticipants) overlayUnassignedParticipants.style.display = 'none';
            if (mainResultActionsTop) mainResultActionsTop.style.display = 'none'; 
            if (overlayCopyBtn) overlayCopyBtn.style.display = 'none'; 
            if (resultOverlay && resultOverlay.style.display === 'flex') {
                resultOverlay.style.display = 'none';
                checkAndCloseBodyOverlay();
            }
        }

        function addName() { 
            if (nameInput && addNameToParticipantsList(nameInput.value.trim())) { 
                renderNameList(); 
                nameInput.value = ''; 
            } 
            if (nameInput) nameInput.focus(); 
        }
        function shuffleArray(array) { 
            const newArray = [...array]; 
            for (let i = newArray.length - 1; i > 0; i--) { 
                const j = Math.floor(Math.random() * (i + 1)); 
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]]; 
            } 
            return newArray; 
        }

        function randomizePasses() {
            if (participants.length === 0) { alert('Lägg till passkyttar först!'); return; } 
            clearResults();
            if (noResultsInfo) noResultsInfo.style.display = 'none'; 

            const shuffledParticipants = shuffleArray(participants);
            let unassignedP = [];

            function createResultListItem(passIdentifier, assignedPerson) {
                const li = document.createElement('li');
                li.innerHTML = `<span>${passIdentifier}:</span> ${assignedPerson}`;
                return li;
            }

            if (customPasses.length > 0) {
                const availableParticipants = [...shuffledParticipants];
                customPasses.forEach(passId => { 
                    const assignedParticipant = availableParticipants.length > 0 ? availableParticipants.shift() : "<i>Ledigt</i>";
                    if(resultsList) resultsList.appendChild(createResultListItem(passId, assignedParticipant));
                    if(overlayResultsList) overlayResultsList.appendChild(createResultListItem(passId, assignedParticipant));
                });
                unassignedP = availableParticipants;
            } else {
                shuffledParticipants.forEach((name, index) => {
                    const passIdentifier = `Pass ${index + 1}`;
                    if(resultsList) resultsList.appendChild(createResultListItem(passIdentifier, name));
                    if(overlayResultsList) overlayResultsList.appendChild(createResultListItem(passIdentifier, name));
                });
            }

            if (unassignedP.length > 0) {
                const unassignedText = `<strong>Oplacerade passkyttar:</strong> ${unassignedP.join(', ')}`; 
                if(unassignedParticipantsList) { unassignedParticipantsList.innerHTML = unassignedText; unassignedParticipantsList.style.display = 'block'; }
                if(overlayUnassignedParticipants) { overlayUnassignedParticipants.innerHTML = unassignedText; overlayUnassignedParticipants.style.display = 'block'; }
            } else {
                if(unassignedParticipantsList) unassignedParticipantsList.style.display = 'none';
                if(overlayUnassignedParticipants) overlayUnassignedParticipants.style.display = 'none';
            }

            if (resultsList && resultsList.hasChildNodes()) {
                 if(mainResultActionsTop) mainResultActionsTop.style.display = 'flex'; 
                 if(overlayCopyBtn) overlayCopyBtn.style.display = 'inline-flex'; 
            }
            showResultOverlay(); 
        }
        
        function showResultOverlay() {
             if (resultOverlay && resultsList && resultsList.hasChildNodes()) { 
                closeAllOverlays(); 
                resultOverlay.style.display = 'flex';
                document.body.classList.add('overlay-open');
            }
        }

        function closeResultOverlay() { if (resultOverlay) { resultOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); } }
        function openHelpOverlay() { if (helpOverlay) { closeAllOverlays(); helpOverlay.style.display = 'flex'; document.body.classList.add('overlay-open'); } }
        function closeHelpOverlay() { if (helpOverlay) { helpOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); } }

        function generateQRCode() {
            if (!qrCodeContainer || typeof QRious === 'undefined') return;
            try {
                qrCodeContainer.innerHTML = ''; 
                const canvasElement = document.createElement('canvas'); 
                new QRious({ element: canvasElement, value: appURL, size: 188, padding: 5, level: 'H', background: 'white', foreground: 'black' });
                if (canvasElement.width > 0) qrCodeContainer.appendChild(canvasElement);
                if(shareableLink) { shareableLink.href = appURL; shareableLink.textContent = appURL; }
            } catch (error) { console.error("Error QR:", error); }
        }

        function openShareOverlay() { if (shareOverlay) { closeAllOverlays(); generateQRCode(); shareOverlay.style.display = 'flex'; document.body.classList.add('overlay-open'); } }
        function closeShareOverlay() { if (shareOverlay) { shareOverlay.style.display = 'none'; checkAndCloseBodyOverlay(); } }
        
        function closeAllOverlays() { 
            if (resultOverlay) resultOverlay.style.display = 'none';
            if (helpOverlay) helpOverlay.style.display = 'none';
            if (shareOverlay) shareOverlay.style.display = 'none';
            checkAndCloseBodyOverlay();
        }
        function checkAndCloseBodyOverlay() { 
            const anyOverlayOpen = (resultOverlay && resultOverlay.style.display === 'flex') ||
                                 (helpOverlay && helpOverlay.style.display === 'flex') ||
                                 (shareOverlay && shareOverlay.style.display === 'flex');
            if (!anyOverlayOpen && document.body.classList.contains('overlay-open')) {
                document.body.classList.remove('overlay-open');
            }
        }

        function loadParticipantNamesFromFile(event) {
            const file = event.target.files[0];
            if (file && fileInput) {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    let added = 0; e.target.result.split(/\r\n|\n/).forEach(line => { if (addNameToParticipantsList(line.trim())) added++; }); 
                    if (added > 0) renderNameList(); 
                    fileInput.value = ''; 
                };
                reader.onerror = () => alert("Kunde inte läsa passkyttsfilen."); reader.readAsText(file);
            }
        }
        function saveParticipantNamesToFile() {
            if (participants.length === 0) { alert('Inga passkyttar att spara.'); return; }
            const text = participants.join('\n'); const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a'); a.download = 'passkyttlista.txt'; a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
        }

        function toggleAdvancedPassSettings() {
            if (advancedPassSettings) {
                const isOpen = advancedPassSettings.style.display === 'block';
                advancedPassSettings.style.display = isOpen ? 'none' : 'block';
                if (toggleAdvancedPassBtn) toggleAdvancedPassBtn.classList.toggle('open', !isOpen);
            }
        }
        
        function updateCustomPassesSummary() { 
            if (customPassesInfo) {
                 if (customPasses.length > 0) {
                    customPassesInfo.textContent = `Avancerad är aktiv (${customPasses.length} pass tillagda).`;
                } else {
                    customPassesInfo.textContent = 'Inga avancerade inställningar. Standardnumrering (1-n) kommer användas.';
                }
            }
        }

        function updateCustomPassesUI() {
            if (passDistributionTitle) { 
                if (customPasses.length > 0) {
                    passDistributionTitle.textContent = 'Passfördelning (Avancerad)';
                } else {
                    passDistributionTitle.textContent = 'Passfördelning (1-n)';
                }
            }
            renderCustomPassList(); 
            clearResults(); 
        }

        function loadCustomPassesFromFile(event) {
            const file = event.target.files[0];
            if (file && passFileInput) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const loadedPasses = e.target.result.split(/\r\n|\n/).map(line => line.trim()).filter(line => line !== '');
                    const uniqueLoadedPasses = [];
                    const existingPassesLower = customPasses.map(p => p.toLowerCase());

                    loadedPasses.forEach(newPass => {
                        if (!existingPassesLower.includes(newPass.toLowerCase()) && 
                            !uniqueLoadedPasses.map(p => p.toLowerCase()).includes(newPass.toLowerCase())) {
                            uniqueLoadedPasses.push(newPass);
                        }
                    });
                    
                    customPasses.push(...uniqueLoadedPasses);
                    customPasses.sort(smartSortPasses);
                    
                    updateCustomPassesUI();
                    passFileInput.value = '';
                    alert(`${uniqueLoadedPasses.length} nya unika pass laddades och lades till. Total: ${customPasses.length}.`);
                };
                reader.onerror = () => alert("Kunde inte läsa passfilen.");
                reader.readAsText(file);
            }
        }

        function saveCustomPassesToFile() {
            if (customPasses.length === 0) { alert('Ingen avancerad lista att spara.'); return; } 
            const text = customPasses.join('\n'); const blob = new Blob([text], { type: 'text/plain' });
            const a = document.createElement('a'); a.download = 'passlista.txt'; a.href = URL.createObjectURL(blob); a.click(); URL.revokeObjectURL(a.href);
        }

        function clearLoadedCustomPasses() {
            if (confirm("Är du säker på att du vill rensa hela listan med egna pass och återgå till standardnumrering?")) {
                customPasses = [];
                if(passNameInput) passNameInput.value = ''; 
                updateCustomPassesUI();
            }
        }
        
        function copyResultsToClipboard() {
            if (!resultsList) return; let txt = `${passDistributionTitle.textContent}:\n`;
            const items = resultsList.getElementsByTagName('li'); 
            if (items.length === 0) { alert('Inga resultat att kopiera.'); return; }
            for (let i = 0; i < items.length; i++) { txt += items[i].textContent.replace(/<\/?i>/g, '') + '\n'; }
            if (unassignedParticipantsList && unassignedParticipantsList.style.display === 'block' && unassignedParticipantsList.textContent) {
                txt += `\n${unassignedParticipantsList.textContent}\n`;
            }
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(txt.trim()).then(() => alert('Resultaten kopierade!')).catch(() => alert('Kopiering misslyckades.'));
            } else { 
                const ta = document.createElement("textarea"); ta.value = txt.trim(); document.body.appendChild(ta); ta.select(); 
                try { document.execCommand('copy'); alert('Resultaten kopierade!'); } 
                catch (e) { alert('Kopiering misslyckades.'); } 
                document.body.removeChild(ta); 
            }
        }
    </script>
</body>
</html>