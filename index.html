<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Björklunds Kortlek</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#284027"> 
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <style>
        :root {
            /* Ljust Tema (Behåller färgtema_v001.png) */
            --primary-color: #284027;                     
            --primary-color-rgb: 40, 64, 39;
            --primary-text-color: #FBF5E9;              

            --accent-color: #d65d0b;                      
            --accent-color-rgb: 214, 93, 11;
            --accent-text-color: #FFFFFF; 

            --bg-color: #284027; 
            --surface-bg-color: #FBF5E9;                  
            --text-color: #284027;                        
            --secondary-text-color: #5a7d58; 
            
            --secondary-button-bg-color: #EFE4CF;       
            --secondary-button-text-color: var(--primary-color); 
            --secondary-button-border-color: #DCD0B9;    
            
            --border-color: #CC9849;                      
            --subtle-border-color: #E0D5C0;           
            
            --danger-color: #A52A2A;                      
            --danger-secondary-bg: #F8D7DA; 
            --danger-secondary-text-color: #721C24; 
            
            --listening-color: #FFC107; 
            --icon-fill-color: var(--primary-color);      
            --icon-hover-fill-color: #000000; 

            --overlay-bg-color: rgba(var(--primary-color-rgb), 0.75); 
            --overlay-content-bg: var(--surface-bg-color); 
            --overlay-header-text-color: var(--primary-color);
            --overlay-text-color: var(--text-color);
            --overlay-subtle-text-color: var(--secondary-text-color);
            --overlay-link-color: var(--primary-color);

            --tab-inactive-bg: #EFE4CF;                  
            --tab-inactive-text: var(--primary-color);    
            --tab-inactive-hover-bg: #E0D5C0;           
            --tab-inactive-hover-text: var(--primary-color);
            --tab-active-bg: var(--surface-bg-color);     
            --tab-active-text: var(--primary-color);      
            --tab-active-border-accent: #CC9849;      

            --radio-border-color: var(--border-color);
            --radio-checked-color: var(--primary-color);
            --radio-label-color: var(--text-color);

            --input-bg-color: #FFFFFF; 
        }

        body[data-theme="dark"] {
            /* NYTT MÖRKT TEMA enligt din specifikation */
            --primary-color: #365537;                     
            --primary-color-rgb: 54, 85, 55;
            --primary-text-color: #e6e1d6; 

            --accent-color: #b65407;                      
            --accent-color-rgb: 182, 84, 7;
            --accent-text-color: #FFFFFF;                 

            --bg-color: #1e1d1a;                          
            --surface-bg-color: #2b2a26;                  
            --text-color: #e6e1d6;                        
            --secondary-text-color: #b6b0a2;              
            
            --secondary-button-bg-color: #3a372f;        
            --secondary-button-text-color: var(--text-color); 
            --secondary-button-border-color: #555;        
            
            --border-color: #4A4A4A;                      
            --subtle-border-color: #383838;               
            
            --danger-color: #FF8A80;                      
            --danger-secondary-bg: #5C2B2B; 
            --danger-secondary-text-color: #FFCDD2; 
            
            --listening-color: #FFEB3B;                   
            --icon-fill-color: var(--text-color);         
            --icon-hover-fill-color: #fff;                

            --overlay-bg-color: rgba(30, 29, 26, 0.9);    
            --overlay-content-bg: var(--surface-bg-color); 
            --overlay-header-text-color: var(--primary-color); 
            --overlay-text-color: var(--text-color);      
            --overlay-subtle-text-color: var(--secondary-text-color); 
            --overlay-link-color: var(--primary-color);   

            --tab-inactive-bg: #222222;                  
            --tab-inactive-text: var(--secondary-text-color); 
            --tab-inactive-hover-bg: #4A4A4A;           
            --tab-inactive-hover-text: var(--text-color); 
            --tab-active-bg: var(--surface-bg-color);     
            --tab-active-text: var(--text-color);         
            --tab-active-border-accent: var(--accent-color);     

            --radio-border-color: var(--border-color);
            --radio-checked-color: var(--primary-color);
            --radio-label-color: var(--text-color);

            --input-bg-color: #3a372f; 
        }

        *, *::before, *::after { box-sizing: border-box; }
        html { height: 100%; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            margin: 0;
            padding: 0; 
            background-color: var(--bg-color); 
            color: var(--text-color); 
            font-size: 16px;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease; 
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        body.overlay-open {
            overflow: hidden;
        }

        #appRootContainer {
            display: flex;
            flex-direction: column;
            flex-grow: 1; 
            width: 100%;   
            background-color: var(--surface-bg-color); 
            overflow: hidden; 
            max-width: none;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            transition: margin 0.3s ease, border-radius 0.3s ease, box-shadow 0.3s ease, max-width 0.3s ease;
        }

        @media (min-width: 768px) { 
            #appRootContainer {
                max-width: 700px; 
                margin: 10px auto; 
                border-radius: 8px; 
                box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            }
        }
        
        .app-title-bar {
            background-color: var(--primary-color);
            color: var(--primary-text-color);
            padding: 12px 15px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .app-title-bar h1 {
            color: var(--primary-text-color);
            text-align: left;
            margin: 0;
            font-size: 1.4em; 
            font-weight: 500;
            flex-grow: 0; 
            flex-shrink: 1; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        .app-header-actions-container {
            display: flex;
            align-items: center;
            gap: 5px; 
            flex-shrink: 0; 
        }
         .app-header-actions-container .icon-button { 
            background-color: transparent !important; 
            border: none !important; 
            padding: 4px; 
            width: 28px; 
            height: 28px;
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
         .app-header-actions-container .icon-button svg { 
            fill: var(--primary-text-color) !important; 
            width: 20px; height: 20px;
        }
         .app-header-actions-container .icon-button:hover svg {
            fill: color-mix(in srgb, var(--primary-text-color) 80%, black) !important;
        }
        
        .tabs-nav {
            display: flex;
            background-color: var(--tab-inactive-bg); 
            border-bottom: 1px solid var(--subtle-border-color); 
            position: relative;
            padding: 0 5px; 
            flex-shrink: 0; 
        }
        .tab-button {
            flex-grow: 1;
            padding: 12px 8px; 
            cursor: pointer;
            background-color: var(--tab-inactive-bg);
            color: var(--tab-inactive-text); 
            font-size: 0.9em; 
            font-weight: 500;
            text-align: center;
            transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
            font-family: inherit;
            border-top-left-radius: 5px;
            border-top-right-radius: 5px; 
            margin-top: 1px; 
            border: 1px solid transparent; 
            border-bottom: none; 
        }
       
        .tab-button:hover:not(.active) { 
            color: var(--tab-inactive-hover-text);
            background-color: var(--tab-inactive-hover-bg); 
        }

        .tab-button.active {
            background-color: var(--tab-active-bg) !important; 
            color: var(--tab-active-text) !important; 
            font-weight: bold;
            border-left: 1px solid var(--subtle-border-color); 
            border-right: 1px solid var(--subtle-border-color);
            border-top: 1px solid var(--subtle-border-color);  
            border-bottom: 1px solid var(--tab-active-bg) !important; 
            position: relative;
            z-index: 2; 
            margin-bottom: -1px; 
        }
        .tab-button.active:hover { 
            cursor: default; 
        }

        .tab-content {
            padding: 20px 15px; 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
        }

        .tab-content h2 {
            color: var(--primary-color); 
            text-align: left; 
            margin-top: 0; 
            margin-bottom: 20px; 
            font-size: 1.3em; 
            padding-bottom: 8px; 
            border-bottom: 1px solid var(--border-color); 
        }
        #passDistributionTitleContainer {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            width: 100%; 
        }
        #passDistributionTitle {
             flex-grow: 1; 
        }

        .input-group {
            display: flex;
            margin-bottom: 15px;
            gap: 8px; 
            align-items: center; 
        }
        .input-group input[type="text"] {
            flex-grow: 1;
            flex-shrink: 1; 
            min-width: 100px; 
            padding: 10px;
            border: 1px solid var(--border-color); 
            border-radius: 4px;
            font-size: 1em;
            font-family: inherit;
            height: 40px; 
            box-sizing: border-box;
            background-color: var(--input-bg-color); 
            color: var(--text-color); 
        }
        .input-group input[type="text"]::placeholder { color: var(--secondary-text-color); opacity: 1; }
        .input-group input[type="text"]::-ms-input-placeholder { color: var(--secondary-text-color); } 

        button, .button-like { 
            padding: 10px 15px;
            background-color: var(--primary-color); 
            color: var(--primary-text-color);       
            border: 1px solid var(--primary-color); 
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            font-family: inherit; 
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            text-align: center;
            text-decoration: none;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            height: 40px; 
            box-sizing: border-box;
            flex-shrink: 0; 
        }
        
        button:hover:not(:disabled):not(.tab-button), 
        .button-like:hover:not(.tab-button) { 
             background-color: color-mix(in srgb, var(--primary-color) 85%, black);
             border-color: color-mix(in srgb, var(--primary-color) 85%, black);
        }
        button:disabled {
            background-color: var(--secondary-text-color);
            color: color-mix(in srgb, var(--primary-text-color) 70%, transparent);
            border-color: var(--secondary-text-color);
            cursor: not-allowed;
            opacity: 0.6;
        }

        #randomizeBtn { 
            background-color: var(--accent-color);
            color: var(--accent-text-color);
            border-color: var(--accent-color); 
            width: 100%; 
            margin-top: 20px; 
            padding: 15px; 
            font-size: 1.2em;
        }
        #randomizeBtn:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--accent-color) 85%, black);
            border-color: color-mix(in srgb, var(--accent-color) 85%, black);
        }

        .button-secondary,
        .action-buttons .file-input-wrapper .button-like { 
            background-color: var(--secondary-button-bg-color); 
            color: var(--secondary-button-text-color);          
            border: 1px solid var(--secondary-button-border-color); 
        }
        body:not([data-theme="dark"]) .button-secondary:hover:not(:disabled),
        body:not([data-theme="dark"]) .action-buttons .file-input-wrapper .button-like:hover:not(:disabled) {
            background-color: #E0D5C0;      
            border-color: #C9BAA7; 
            color: var(--secondary-button-text-color); 
        }
        body:not([data-theme="dark"]) .button-secondary:focus:not(:disabled),
        body:not([data-theme="dark"]) .action-buttons .file-input-wrapper .button-like:focus:not(:disabled) {
             outline: 2px solid var(--primary-color); 
             outline-offset: 2px;
        }
        body[data-theme="dark"] .button-secondary:hover:not(:disabled),
        body[data-theme="dark"] .action-buttons .file-input-wrapper .button-like:hover:not(:disabled),
        body[data-theme="dark"] .button-secondary:focus:not(:disabled),
        body[data-theme="dark"] .action-buttons .file-input-wrapper .button-like:focus:not(:disabled) {
            background-color: color-mix(in srgb, var(--secondary-button-bg-color) 90%, black 10%); 
        }
         body[data-theme="dark"] .button-secondary:focus:not(:disabled),
         body[data-theme="dark"] .action-buttons .file-input-wrapper .button-like:focus:not(:disabled) {
             outline: 2px solid var(--primary-color); 
             outline-offset: 2px;
        }
        
        .button-danger {
            background-color: var(--danger-secondary-bg); 
            color: var(--danger-secondary-text-color);   
            border: 1px solid var(--danger-color);         
        }
        .button-danger:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--danger-secondary-bg) 85%, var(--danger-color) 15%); 
            color: var(--danger-secondary-text-color);
            border-color: color-mix(in srgb, var(--danger-color) 80%, black);
        }
        body[data-theme="dark"] .button-danger {
            background-color: var(--danger-secondary-bg); 
            color: var(--danger-secondary-text-color);   
            border: 1px solid var(--danger-color);         
        }
        body[data-theme="dark"] .button-danger:hover:not(:disabled) {
            background-color: color-mix(in srgb, var(--danger-secondary-bg) 85%, var(--danger-color) 15%);
            border-color: color-mix(in srgb, var(--danger-color) 80%, white); 
        }


        .icon-button { 
            padding: 8px;
            width: 40px; 
            height: 40px;
            min-width: 40px; 
            background-color: transparent; 
            border: none; 
            flex-shrink: 0;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
        }
        #speakNameBtn.icon-button.button-secondary, 
        #advancedSettingsOverlay #speakPassNameBtn.icon-button.button-secondary { 
             background-color: var(--secondary-button-bg-color); 
             border: 1px solid var(--secondary-button-border-color); 
             padding: 8px; 
             width: 40px;
             height: 40px;
        }
         #speakNameBtn.icon-button.button-secondary svg,
         #advancedSettingsOverlay #speakPassNameBtn.icon-button.button-secondary svg { 
             fill: var(--secondary-button-text-color) !important; 
        }

        .icon-button:not(.app-header-actions-container .icon-button):not(.button-secondary) svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-fill-color); 
            transition: fill 0.3s ease;
        }
        .icon-button:not(.button-secondary):not(.app-header-actions-container .icon-button):hover:not(:disabled) svg, 
        .overlay-header .icon-button:hover:not(:disabled) svg { 
            fill: var(--icon-hover-fill-color); 
        }
        .icon-button.is-listening svg { 
            fill: var(--listening-color) !important; 
        }
        .icon-button:disabled svg:not(.app-header-actions-container .icon-button svg) {
            fill: var(--secondary-text-color) !important;  
            opacity: 0.6;
        }

        #openAdvancedSettingsBtn { 
            background-color: transparent !important; 
            border: none !important;
            padding: 0 5px 0 10px; 
        }
        #openAdvancedSettingsBtn svg {
            width: 20px;
            height: 20px;
            fill: var(--icon-fill-color) !important; 
            transition: fill 0.3s ease; 
        }
        #openAdvancedSettingsBtn:hover svg {
            fill: var(--icon-hover-fill-color) !important;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 10px; 
            flex-wrap: wrap; 
        }
         .action-buttons > button, 
         .action-buttons > .file-input-wrapper {
            font-size: 0.9em; 
            height: auto; 
            flex-basis: calc(50% - 5px); 
            min-width: 130px; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch; 
         }
         .action-buttons > button:not(.button-like) { 
            padding: 8px 12px; 
            height: 38px; 
            align-items: center; 
            justify-content: center;
         }
         .action-buttons .file-input-wrapper .button-like { 
            width: 100%; 
            font-size: 1em; 
            padding: 8px 10px; 
            height: 38px;
         }
        #advancedSettingsOverlay .action-buttons > button,
        #advancedSettingsOverlay .action-buttons > .file-input-wrapper {
            flex-basis: 100%; 
            margin-bottom: 8px;
        }
        @media (min-width: 480px) { 
            #advancedSettingsOverlay .action-buttons > .file-input-wrapper,
            #advancedSettingsOverlay .action-buttons > button#savePassListBtn,
            #advancedSettingsOverlay .action-buttons > button#clearCustomPassesBtn {
                 flex-basis: calc(33.333% - 7px); 
                 min-width: 100px;
                 margin-bottom: 0; 
            }
            #advancedSettingsOverlay .action-buttons > .file-input-wrapper { min-width: 120px; }
             #advancedSettingsOverlay .action-buttons {
                 justify-content: space-around; 
             }
        }
        
         .file-format-info {
            font-size: 0.8em;
            font-style: italic;
            color: var(--secondary-text-color); 
            text-align: center; 
            margin-top: 4px; 
            margin-bottom: 0; 
            padding: 0 5px; 
            line-height: 1.2; 
         }

        #nameList ul, #resultsList ul, #overlayResultsList ul, 
        #advancedSettingsOverlay #customPassDisplayList ul { 
            list-style-type: none;
            padding: 0;
            margin: 0; 
        }

        #nameList li, #resultsList li, #overlayResultsList li, 
        #advancedSettingsOverlay #customPassDisplayList li { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px; 
            border-bottom: 1px solid var(--subtle-border-color); 
            word-break: break-word; 
            color: var(--text-color); 
        }
        #resultsList li span:first-child, #overlayResultsList li span:first-child { 
            margin-right: 8px; 
            font-weight: bold;
            color: var(--text-color); 
        }

        #nameList li:last-child, #resultsList li:last-child, 
        #overlayResultsList li:last-child, 
        #advancedSettingsOverlay #customPassDisplayList li:last-child { 
            border-bottom: none;
        }

        .delete-btn { 
            background-color: transparent !important; 
            border: none !important;
            padding: 4px; 
        }
        .delete-btn svg {
            fill: var(--danger-color) !important; 
            width: 18px; 
            height: 18px;
            transition: fill 0.2s ease-in-out;
        }
        .delete-btn:hover svg {
            fill: color-mix(in srgb, var(--danger-color) 80%, black) !important; 
        }

        hr {
            border: 0;
            height: 1px;
            background-color: var(--border-color); 
            margin: 25px 0; 
        }

        input[type="file"] { 
            position: absolute !important;
            left: -9999px !important;
            width: 1px !important;
            height: 1px !important;
            opacity: 0 !important;
            pointer-events: none !important;
            overflow: hidden !important; 
        }
        
        .info-text {
            color: var(--secondary-text-color); 
            font-size: 0.9em; 
            text-align: center;
            margin-top: 10px;
        }
        #participantsCountInfo, #passDistributionMethodInfo { 
            margin-top: 10px; 
            padding: 5px 0; 
        }
         #noCustomPassesInfo, 
         #noNamesInfo, 
         #noResultsInfo { 
            padding: 15px 0; 
         }
         #participantsCountInfo { 
            color: var(--secondary-text-color); 
            font-weight: 500; 
         }
         #passDistributionMethodInfo { 
            font-style: italic;
            margin-top: 5px; 
            margin-bottom: 15px; 
         }
        #advancedSettingsOverlay #customPassesInfoInOverlay { 
            font-size: 0.9em;
            text-align: center;
            color: var(--primary-color); 
            font-weight: 500;
            margin-top: 10px; 
            margin-bottom: 10px; 
        }
        
        #unassignedParticipantsList {
            color: var(--danger-color); 
            margin-top: 10px;
        }
        #unassignedParticipantsList strong {
            color: var(--text-color); 
        }

        #advancedSettingsOverlay .radio-group-container {
            margin-bottom: 20px;
            padding: 10px 15px 15px 15px; 
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: color-mix(in srgb, var(--surface-bg-color) 98%, var(--bg-color) 2%);
        }
        #advancedSettingsOverlay .radio-group-container legend {
            font-weight: bold;
            color: var(--primary-color);
            padding: 0 5px;
            margin-left: -5px; 
            font-size: 1em;
            margin-bottom: 8px;
        }
        #advancedSettingsOverlay .radio-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0; 
        }
        #advancedSettingsOverlay .radio-option:last-child {
            margin-bottom: 0;
        }
        #advancedSettingsOverlay .radio-option input[type="radio"] {
            margin-right: 10px;
            appearance: none;
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--radio-border-color);
            border-radius: 50%;
            outline: none;
            cursor: pointer;
            position: relative;
            top: -1px; 
            flex-shrink: 0; 
        }
        #advancedSettingsOverlay .radio-option input[type="radio"]:checked {
            border-color: var(--radio-checked-color);
        }
        #advancedSettingsOverlay .radio-option input[type="radio"]:checked::before {
            content: '';
            display: block;
            width: 10px;
            height: 10px;
            background-color: var(--radio-checked-color);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        #advancedSettingsOverlay .radio-option label {
            font-size: 0.95em;
            cursor: pointer;
            color: var(--radio-label-color);
            line-height: 1.3; 
        }
        
        #advancedSettingsOverlay #customPassElementsContainer { 
            padding-top: 10px;
            border-top: 1px solid var(--subtle-border-color);
            margin-top: 15px;
        }
        #advancedSettingsOverlay #customPassElementsContainer.disabled-look {
            opacity: 0.6;
            pointer-events: none; 
        }
         #advancedSettingsOverlay #customPassElementsContainer > p:first-of-type { 
             margin-top:0; 
             margin-bottom: 15px;
             font-size: 0.85em;
             color: var(--overlay-subtle-text-color);
         }

        .content-overlay { 
            background-color: var(--overlay-bg-color); 
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000;
            align-items: center; justify-content: center;
            padding: 10px; 
            box-sizing: border-box;
        }
         @media (min-width: 480px) { 
            .content-overlay { padding: 15px; }
         }
        
        #resultOverlay.content-overlay { 
            background-color: rgba(var(--accent-color-rgb), 0.85); 
        }
        body[data-theme="dark"] #resultOverlay.content-overlay {
             background-color: rgba(var(--accent-color-rgb), 0.9); 
        }


        .overlay-content-box {
            background-color: var(--overlay-content-bg); 
            padding: 15px; 
            border-radius: 8px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            max-width: 550px; 
            width: 100%;
            max-height: 90vh; 
            display: flex; flex-direction: column;
        }
        @media (min-width: 600px) { 
            .overlay-content-box { padding: 20px; }
        }
        
        .overlay-header { 
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px; 
            border-bottom: 1px solid var(--border-color); 
        }
        .overlay-header h3 {
            color: var(--overlay-header-text-color); 
            text-align: left; margin: 0; 
            font-size: 1.4em; 
            flex-grow: 1; 
        }
        .overlay-header .icon-button { 
            background-color: transparent !important; border: none !important;
            width: 30px; height: 30px; padding: 5px;
        }
        .overlay-header .icon-button svg { 
            fill: var(--icon-fill-color) !important; 
            width: 18px; height: 18px;
        }

        .overlay-scrollable-content { 
             color: var(--overlay-text-color); 
             overflow-y: auto; flex-grow: 1; 
             margin-bottom: 15px; 
             padding-right: 5px; 
        }
        #advancedSettingsOverlay .overlay-scrollable-content { 
            padding-right: 2px; 
        }

        #advancedSettingsOverlay #customPassListSectionInOverlay {
            border: 1px solid var(--border-color); border-radius: 4px;
            padding: 10px; margin-top: 15px; margin-bottom: 10px; 
            background-color: color-mix(in srgb, var(--surface-bg-color) 98%, var(--bg-color) 2%);
            min-height: 50px; 
        }
        #advancedSettingsOverlay #customPassDisplayList { 
             /* max-height: 150px; */ 
             /* overflow-y: auto;   */ 
        }

        .overlay-results-list-container {
            border: 1px solid var(--border-color); 
            padding: 10px; border-radius: 4px;
            background-color: color-mix(in srgb, var(--surface-bg-color) 98%, var(--bg-color) 2%);
            margin-bottom: 15px; 
        }

        #helpOverlay .overlay-scrollable-content h4 { 
            color: var(--overlay-header-text-color); 
            border-bottom: none; margin-top: 0; margin-bottom: 10px;
            padding-bottom: 0; font-size: 1.2em;
        }
        #helpOverlay .overlay-scrollable-content h4:first-child { margin-top: 0; }
        #helpOverlay .overlay-scrollable-content h5 {
            color: var(--overlay-text-color); 
            margin-top: 15px; margin-bottom: 5px; font-size: 1.1em; 
        }
        #helpOverlay .overlay-scrollable-content p, 
        #helpOverlay .overlay-scrollable-content ol,
        #helpOverlay .overlay-scrollable-content ul { 
            margin-bottom: 10px; font-size: 0.95em;
        }
        #helpOverlay .overlay-scrollable-content ol,
        #helpOverlay .overlay-scrollable-content ul { padding-left: 20px; }
        #helpOverlay .overlay-scrollable-content li { 
            margin-bottom: 5px; border-bottom: none; 
        }
        #helpOverlay .overlay-scrollable-content p svg {
            display:inline-block; width:1em; height:1em;
            vertical-align:-0.125em; fill: currentColor;
        }

        #qrCodeContainer {
            border:1px solid var(--border-color); background:white; 
            margin: 20px auto; width: 180px; height: 180px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 4px; 
        }
        #qrCodeContainer canvas { display: block; }

        #shareableLink {
            color: var(--overlay-link-color); font-weight: 500; 
        }
        
        .result-actions-top {
            display: none; justify-content: flex-end; align-items: center;
            margin-bottom: 8px; gap: 0px; 
        }
        .result-actions-top .icon-button {
            padding: 6px; width: 34px; height: 34px;
        }
        .result-actions-top .icon-button svg {
            width: 20px; height: 20px;
        }
        body[data-theme="dark"] .result-actions-top #reopenOverlayBtn svg {
            fill: var(--accent-color) !important;
        }
        body[data-theme="dark"] .result-actions-top #reopenOverlayBtn:hover svg {
            fill: color-mix(in srgb, var(--accent-color) 85%, white) !important;
        }
        
        .overlay-content-box > button.overlay-close-btn:last-child:not(.icon-button) {
             margin-top: auto; width: 100%;
        }

        /* Custom Alert & Confirm Modals Styling */
        #customAlertModal .overlay-content-box,
        #customConfirmModal .overlay-content-box {
            max-width: 400px;
        }
        #customAlertModal .overlay-header,
        #customConfirmModal .overlay-header {
            margin-bottom: 10px;
            padding-bottom: 8px; /* Lättare padding */
        }
        #customAlertModal .overlay-header h3,
        #customConfirmModal .overlay-header h3 {
            font-size: 1.25em; /* Något mindre titel */
        }
        #customAlertModal .overlay-scrollable-content,
        #customConfirmModal .overlay-scrollable-content {
            margin-bottom: 15px; /* Mindre marginal */
            padding: 0 15px; /* Padding för innehåll */
            text-align: center;
        }
        #customAlertModal #customAlertMessage,
        #customConfirmModal #customConfirmMessage {
            font-size: 1em;
            line-height: 1.4;
            margin: 10px 0;
        }
        #customAlertModal .overlay-content-box > div:last-child, /* Knappcontainer */
        #customConfirmModal .overlay-content-box > div:last-child { /* Knappcontainer */
            display: flex;
            justify-content: center; /* Centrera OK-knapp i alert */
            gap: 10px;
            margin-top: auto; /* Tryck ner i botten */
            padding-top: 10px; /* Lite luft ovanför knapparna */
        }
        #customConfirmModal .overlay-content-box > div:last-child {
            justify-content: space-around; /* Behåll space-around för confirm */
        }
        #customAlertOkBtn, #customConfirmOkBtn, #customConfirmCancelBtn {
            flex-grow: 1; /* Låt knappar i confirm växa */
            min-width: 100px; /* Minimumbredd */
        }
        #customAlertOkBtn {
            flex-grow: 0; /* Låt inte OK-knappen i alert växa för mycket */
        }
    </style>
</head>
<body>
    <div id="appRootContainer">
        <div class="app-title-bar">
            <h1>Björklunds Kortlek</h1>
            <div class="app-header-actions-container">
                <button id="themeToggleBtn" class="icon-button" title="Växla tema">
                    <svg id="themeIconMoon" viewBox="0 0 24 24" style="display: none;"><path d="M12 1.993C11.419 1.993 10.847 2.022 10.285 2.076C5.262 2.58 1.993 6.832 1.993 11.999C1.993 17.635 6.365 22 11.999 22C16.957 22 21.145 18.053 21.904 13.269C21.951 12.989 21.979 12.705 21.993 12.416C21.964 12.393 21.938 12.372 21.911 12.353C16.334 11.653 12.707 7.586 12.085 1.993H12Z"/></svg>
                    <svg id="themeIconSun" viewBox="0 0 16 16" style="display: block;"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/></svg>
                </button>
                <button id="helpBtn" class="icon-button" title="Hjälp"><svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8s8 3.59 8 8-3.59 8-8 8zm-1-5h2v2h-2v-2zm0-8h2v6h-2V7z"/></svg></button>
                <button id="shareBtn" class="icon-button" title="Dela appen"><svg viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                <button id="installAppBtn" class="icon-button" title="Installera appen" style="display: none;"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></button>
            </div>
        </div>

        <nav class="tabs-nav">
            <button class="tab-button active" data-tab="participantsTab">Passkyttar</button>
            <button class="tab-button" data-tab="distributionTab">Passfördelning</button>
        </nav>

        <section id="participantsTab" class="tab-content">
            <h2>Passkyttar</h2> 
            <div class="input-group">
                <input type="text" id="nameInput" placeholder="Ange passkytt...">
                <button id="addNameBtn">Lägg till</button>
                <button id="speakNameBtn" class="icon-button button-secondary" title="Tala in passkytt"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg></button>
            </div>
            <div class="action-buttons">
                <div class="file-input-wrapper">
                    <label for="fileInput" class="button-like button-secondary">Läs in passkyttar</label>
                    <input type="file" id="fileInput" accept=".txt">
                    <p class="file-format-info">.txt (en passkytt per rad)</p>
                </div>
                <button id="saveNamesBtn" class="button-secondary">Spara passkyttlista</button>
            </div>
            <section id="nameListSection" style="margin-top: 15px;">
                <ul id="nameList"></ul>
                <p id="participantsCountInfo" class="info-text"></p>
                <p id="noNamesInfo" class="info-text" style="display: none;">Inga passkyttar tillagda.</p>
            </section>
            <!-- Rensa-knapp BORTTAGEN -->
        </section>

        <section id="distributionTab" class="tab-content" style="display: none;">
            <section id="resultsSection">
                <h2>
                    <div id="passDistributionTitleContainer">
                        <span id="passDistributionTitle">Passfördelning</span> 
                        <button id="openAdvancedSettingsBtn" class="icon-button" title="Passinställningar"> 
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                        </button>
                    </div>
                </h2>
                
                <p id="passDistributionMethodInfo" class="info-text"></p> 

                <div class="result-actions-top" id="mainResultActionsTop">
                    <button id="mainCopyBtn" class="icon-button" title="Kopiera resultat"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                    <button id="reopenOverlayBtn" class="icon-button" title="Visa resultat i helskärm"><svg viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg></button>
                </div>

                <ul id="resultsList"></ul>
                <p id="unassignedParticipantsList" class="info-text" style="display:none;"></p>
                <p id="noResultsInfo" class="info-text">Klicka på "Slumpa Pass" för att se resultat.</p>
            </section>
            <button id="randomizeBtn">Slumpa Pass</button>
        </section>
    </div> <!-- End of #appRootContainer -->

    <!-- Overlay för Avancerade Passinställningar -->
    <div id="advancedSettingsOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Passinställningar</h3>
                <button id="advancedSettingsOverlayHeaderCloseBtn" class="icon-button overlay-close-btn" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="overlay-scrollable-content">
                <fieldset class="radio-group-container">
                    <legend>Typ av Passfördelning</legend>
                    <div class="radio-option">
                        <input type="radio" id="passModeStandard" name="passMode" value="standard" checked>
                        <label for="passModeStandard">Använd standardnumrering 1-n (Standard)</label>
                    </div>
                    <div class="radio-option">
                        <input type="radio" id="passModeAdvanced" name="passMode" value="advanced">
                        <label for="passModeAdvanced">Använd en egen lista med passnamn/nummer (Avancerad)</label>
                    </div>
                </fieldset>

                <div id="customPassElementsContainer"> 
                    <p style="font-size: 0.85em; color: var(--overlay-subtle-text-color); text-align: center; margin-bottom:15px;">
                        Här kan du definiera en egen lista med pass-ID. Listan används endast om "Avancerad" är valt ovan.
                    </p>
                    <div class="input-group" id="passInputGroupInOverlay"> 
                        <input type="text" id="passNameInput" placeholder="Ange pass-ID...">
                        <button id="addPassNameBtn">Lägg till pass</button>
                        <button id="speakPassNameBtn" class="icon-button button-secondary" title="Tala in pass-ID"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.58 14.34 14.5 16 12 16s-4.58-1.66-4.93-4.15a1 1 0 0 0-.98-.85c-.61 0-1.09.54-1 1.14C5.55 15.18 8.41 17 12 17s6.45-1.82 6.91-4.86c.09-.6-.39-1.14-1-1.14z"/><path d="M12 19c-2.21 0-4-1.79-4-4h2c0 1.1.9 2 2 2s2-.9 2-2h2c0 2.21-1.79 4-4 4z"/></svg></button>
                    </div>

                    <div class="action-buttons"> 
                        <div class="file-input-wrapper">
                            <label for="passFileInput" class="button-like button-secondary">Läs in pass från fil</label>
                            <input type="file" id="passFileInput" accept=".txt">
                            <p class="file-format-info">.txt (ett pass-ID per rad)</p>
                        </div>
                        <button id="savePassListBtn" class="button-secondary">Spara passlista</button>
                        <button id="clearCustomPassesBtn" class="button-secondary">Rensa hela listan</button> 
                    </div>

                    <section id="customPassListSectionInOverlay"> 
                        <ul id="customPassDisplayList"></ul> 
                        <p id="noCustomPassesInfo" class="info-text" style="display: none;">Inga egna pass tillagda.</p>
                    </section>
                    
                    <p id="customPassesInfoInOverlay" class="info-text"></p> 
                </div> 
            </div>
            <button id="advancedSettingsOverlayCloseButtonBottom" class="overlay-close-btn">Stäng</button>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="resultOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Slumpat Resultat</h3>
                <button id="overlayCopyBtn" class="icon-button" title="Kopiera resultat" style="display: none;"><svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg></button>
                 <button id="resultOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="overlay-results-list-container overlay-scrollable-content"> 
                <ul id="overlayResultsList"></ul>
            </div>
            <p id="overlayUnassignedParticipants" class="info-text" style="display:none; margin-bottom: 15px;"></p>
        </div>
    </div>

    <div id="helpOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Hjälp & Information</h3>
                 <button id="helpOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="overlay-scrollable-content">
                <h4>Installera Appen på Din Hemskärm</h4>
                <p>För enklare åtkomst kan du lägga till Björklunds Kortlek på din mobils hemskärm. Den kommer då att fungera mer som en vanlig app.</p>
                <h5>Android (t.ex. Chrome):</h5>
                <ol>
                    <li>Öppna appen i din Chrome-webbläsare.</li>
                    <li>Tryck på menyknappen (ofta tre prickar uppe till höger).</li>
                    <li>Välj "Installera appen" eller "Lägg till på startskärmen".</li>
                    <li>Följ instruktionerna.</li>
                </ol>
                <p><em>Alternativt kan en "Installera App"-knapp ( <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg> ) dyka upp automatiskt högst upp i appen när du använt sidan ett tag.</em></p>
                <h5>iOS (iPhone/iPad - Safari):</h5>
                <ol>
                    <li>Öppna appen i Safari-webbläsaren.</li>
                    <li>Tryck på Dela-ikonen (en ruta med en pil som pekar uppåt) längst ner (eller uppe) i webbläsaren.</li>
                    <li>Skrolla ner i delningsmenyn och välj "Lägg till på hemskärmen".</li>
                    <li>Bekräfta namnet och tryck "Lägg till".</li>
                </ol>
                <hr style="margin: 15px 0;">
                <h4>Grundläggande Användning</h4>
                <p><strong>Fliken "Passkyttar":</strong></p>
                <ul>
                    <li><strong>Lägg till Passkyttar:</strong> Skriv namn i fältet och klicka "Lägg till" eller tala in namn med mikrofonikonen. Antalet tillagda passkyttar visas under listan.</li>
                     <li><strong>Filhantering:</strong> Läs in en lista med passkyttar från en .txt-fil eller spara den aktuella listan till en fil.</li>
                </ul>
                <p><strong>Fliken "Passfördelning":</strong></p>
                 <ul>
                    <li><strong>Passinställningar (Kugghjulet <svg style="display:inline-block; width:1em; height:1em; vertical-align:-0.125em; fill:currentColor;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>):</strong> Öppnar ett fönster där du kan välja mellan "Standardnumrering 1-n" eller "Använd en egen lista med passnamn/nummer". Om du väljer "Avancerad", visas ytterligare kontroller för att mata in pass-ID manuellt (eller via röst), ladda från/spara till fil, samt rensa listan. Den definierade listan och antalet pass i den visas i detta fönster.</li>
                    <li><strong>Slumpa Pass:</strong> Klicka på den stora orangea "Slumpa Pass"-knappen. Resultatet visas både i huvudvyn och i ett helskärmsläge. En informationstext under passfördelningsrubriken i huvudvyn anger hur passen kommer att fördelas.</li>
                    <li><strong>Återöppna Resultat:</strong> Använd ögon-ikonen (<svg viewBox="0 0 24 24" style="display:inline-block; width:1em; height:1em; vertical-align:-0.125em; fill:currentColor;"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>) ovanför resultatlistan i huvudvyn för att återöppna helskärmsresultatet.</li>
                    <li><strong>Kopiera/Dela:</strong> Använd kopieringsikonen (<svg viewBox="0 0 24 24" style="display:inline-block; width:1em; height:1em; vertical-align:-0.125em; fill:currentColor;"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>) för att kopiera resultatlistan. Använd dela-ikonen (<svg viewBox="0 0 24 24" style="display:inline-block; width:1em; height:1em; vertical-align:-0.125em; fill:currentColor;"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 8.81C7.5 8.31 6.79 8 6 8c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"/></svg>) högst upp för att dela en länk till appen via en QR-kod.</li>
                </ul>
            </div>
        </div>
    </div>

    <div id="shareOverlay" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header">
                <h3>Dela Björklunds Kortlek</h3>
                <button id="shareOverlayCloseBtn" class="icon-button overlay-close-btn" title="Stäng"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="overlay-scrollable-content" style="text-align: center;">
                <p>Skanna QR-koden nedan med en annan enhet, eller dela länken:</p>
                <div id="qrCodeContainer"><!-- QR-kod --></div>
                <p style="word-break: break-all;"><strong>Länk:</strong> <a id="shareableLink" href="https://stevoxa.github.io/bjorklunds-kortlek/" target="_blank" rel="noopener noreferrer">https://stevoxa.github.io/bjorklunds-kortlek/</a></p>
            </div>
        </div>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header" id="customAlertHeader">
                <h3 id="customAlertTitle">Meddelande</h3>
            </div>
            <div class="overlay-scrollable-content">
                <p id="customAlertMessage"></p>
            </div>
            <div>
                <button id="customAlertOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- Custom Confirm Modal -->
    <div id="customConfirmModal" class="content-overlay" style="display: none;">
        <div class="overlay-content-box">
            <div class="overlay-header" id="customConfirmHeader">
                <h3 id="customConfirmTitle">Bekräfta åtgärd</h3>
            </div>
            <div class="overlay-scrollable-content">
                <p id="customConfirmMessage"></p>
            </div>
            <div>
                <button id="customConfirmCancelBtn" class="button-secondary">Avbryt</button>
                <button id="customConfirmOkBtn">OK</button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM ELEMENT REFERENSER ---
        let themeToggleBtn, themeIconSun, themeIconMoon, nameInput, addNameBtn, nameList,
            randomizeBtn, resultsList, fileInput, saveNamesBtn, noNamesInfo, noResultsInfo,
            speakNameBtn, unassignedParticipantsList, passDistributionTitle, resultOverlay, 
            overlayResultsList, overlayUnassignedParticipants, mainResultActionsTop, reopenOverlayBtn, 
            mainCopyBtn, overlayCopyBtn, helpBtn, shareBtn, helpOverlay, shareOverlay, 
            qrCodeContainer, shareableLink, installAppBtn,
            participantsCountInfo,
            passDistributionMethodInfo; 
        
        let openAdvancedSettingsBtn, advancedSettingsOverlay, passModeStandardRadio, 
            passModeAdvancedRadio, customPassElementsContainer, customPassesInfoInOverlay, 
            passNameInput_overlay, addPassNameBtn_overlay, speakPassNameBtn_overlay,
            passFileInput_overlay, savePassListBtn_overlay, clearCustomPassesBtn_overlay,
            customPassDisplayList_overlay, noCustomPassesInfo_overlay;

        let tabButtons, tabContents;
        const LAST_ACTIVE_TAB_KEY = 'bjorklundsKortlekLastActiveTab_v1';
        const PASS_DISTRIBUTION_CONFIG_MODE_KEY = 'bjorklundsKortlekPassConfigMode_v1';
        const CUSTOM_PASSES_KEY = 'bjorklundsKortlekCustomPasses_v1'; 
        const PARTICIPANTS_KEY = 'bjorklundsKortlekParticipants_v1';

        let participants = JSON.parse(localStorage.getItem(PARTICIPANTS_KEY)) || [];
        let customPasses = JSON.parse(localStorage.getItem(CUSTOM_PASSES_KEY)) || [];
        let passDistributionConfigMode = localStorage.getItem(PASS_DISTRIBUTION_CONFIG_MODE_KEY) || 'standard';
        let currentTheme = localStorage.getItem('theme') || (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        let deferredPrompt;
        const appURL = "https://stevoxa.github.io/bjorklunds-kortlek/"; 
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition; 
        let passRecognition;  

        // Custom Alert & Confirm Modal DOM elements
        let customAlertModal, customAlertTitle, customAlertHeader, customAlertMessage, customAlertOkBtn;
        let customConfirmModal, customConfirmTitle, customConfirmHeader, customConfirmMessage, customConfirmOkBtn, customConfirmCancelBtn;
        let currentConfirmCallback = null;
        let currentCancelCallback = null;


        document.addEventListener('DOMContentLoaded', () => {
            themeToggleBtn = document.getElementById('themeToggleBtn');
            themeIconSun = document.getElementById('themeIconSun');
            themeIconMoon = document.getElementById('themeIconMoon');
            nameInput = document.getElementById('nameInput');
            addNameBtn = document.getElementById('addNameBtn');
            nameList = document.getElementById('nameList');
            randomizeBtn = document.getElementById('randomizeBtn');
            resultsList = document.getElementById('resultsList');
            fileInput = document.getElementById('fileInput'); 
            saveNamesBtn = document.getElementById('saveNamesBtn');
            noNamesInfo = document.getElementById('noNamesInfo');
            noResultsInfo = document.getElementById('noResultsInfo');
            speakNameBtn = document.getElementById('speakNameBtn');
            unassignedParticipantsList = document.getElementById('unassignedParticipantsList');
            passDistributionTitle = document.getElementById('passDistributionTitle');
            resultOverlay = document.getElementById('resultOverlay');
            overlayResultsList = document.getElementById('overlayResultsList');
            overlayUnassignedParticipants = document.getElementById('overlayUnassignedParticipants');
            mainResultActionsTop = document.getElementById('mainResultActionsTop');
            reopenOverlayBtn = document.getElementById('reopenOverlayBtn');
            mainCopyBtn = document.getElementById('mainCopyBtn'); 
            overlayCopyBtn = document.getElementById('overlayCopyBtn'); 
            helpBtn = document.getElementById('helpBtn');
            shareBtn = document.getElementById('shareBtn');
            helpOverlay = document.getElementById('helpOverlay');
            shareOverlay = document.getElementById('shareOverlay');
            qrCodeContainer = document.getElementById('qrCodeContainer');
            shareableLink = document.getElementById('shareableLink');
            installAppBtn = document.getElementById('installAppBtn');
            participantsCountInfo = document.getElementById('participantsCountInfo');
            passDistributionMethodInfo = document.getElementById('passDistributionMethodInfo');
            
            openAdvancedSettingsBtn = document.getElementById('openAdvancedSettingsBtn');
            advancedSettingsOverlay = document.getElementById('advancedSettingsOverlay');
            passModeStandardRadio = document.getElementById('passModeStandard');
            passModeAdvancedRadio = document.getElementById('passModeAdvanced');
            customPassElementsContainer = document.getElementById('customPassElementsContainer');
            
            passNameInput_overlay = advancedSettingsOverlay.querySelector('#passNameInput'); 
            addPassNameBtn_overlay = advancedSettingsOverlay.querySelector('#addPassNameBtn');
            speakPassNameBtn_overlay = advancedSettingsOverlay.querySelector('#speakPassNameBtn');
            passFileInput_overlay = advancedSettingsOverlay.querySelector('#passFileInput');
            savePassListBtn_overlay = advancedSettingsOverlay.querySelector('#savePassListBtn');
            clearCustomPassesBtn_overlay = advancedSettingsOverlay.querySelector('#clearCustomPassesBtn');
            customPassDisplayList_overlay = advancedSettingsOverlay.querySelector('#customPassDisplayList');
            noCustomPassesInfo_overlay = advancedSettingsOverlay.querySelector('#noCustomPassesInfo');
            customPassesInfoInOverlay = advancedSettingsOverlay.querySelector('#customPassesInfoInOverlay');
            
            tabButtons = document.querySelectorAll('.tab-button');
            tabContents = document.querySelectorAll('.tab-content');

            // Custom Alert & Confirm Modal elements
            customAlertModal = document.getElementById('customAlertModal');
            customAlertTitle = document.getElementById('customAlertTitle');
            customAlertHeader = document.getElementById('customAlertHeader');
            customAlertMessage = document.getElementById('customAlertMessage');
            customAlertOkBtn = document.getElementById('customAlertOkBtn');

            customConfirmModal = document.getElementById('customConfirmModal');
            customConfirmTitle = document.getElementById('customConfirmTitle');
            customConfirmHeader = document.getElementById('customConfirmHeader');
            customConfirmMessage = document.getElementById('customConfirmMessage');
            customConfirmOkBtn = document.getElementById('customConfirmOkBtn');
            customConfirmCancelBtn = document.getElementById('customConfirmCancelBtn');


            document.querySelectorAll('.content-overlay').forEach(o => o.style.display = 'none');
            if (installAppBtn) installAppBtn.style.display = 'none'; 
            if (mainResultActionsTop) mainResultActionsTop.style.display = 'none';
            if (overlayCopyBtn) overlayCopyBtn.style.display = 'none';
            if (participantsCountInfo) participantsCountInfo.style.display = 'none';
            document.body.classList.remove('overlay-open'); 
            
            applyTheme(currentTheme); 
            initializeTabs();
            renderNameList(); 
            updatePassDistributionConfigUI(); 

            if (addNameBtn) addNameBtn.addEventListener('click', addName);
            if (nameInput) nameInput.addEventListener('keypress', (event) => { if (event.key === 'Enter') addName(); });
            if (randomizeBtn) randomizeBtn.addEventListener('click', randomizePasses);
            if (fileInput) fileInput.addEventListener('change', loadParticipantNamesFromFile);
            if (saveNamesBtn) saveNamesBtn.addEventListener('click', saveParticipantNamesToFile);
            if (openAdvancedSettingsBtn) openAdvancedSettingsBtn.addEventListener('click', openAdvancedSettingsModal);
            if (passModeStandardRadio) passModeStandardRadio.addEventListener('change', handlePassDistributionModeChange);
            if (passModeAdvancedRadio) passModeAdvancedRadio.addEventListener('change', handlePassDistributionModeChange);
            if (addPassNameBtn_overlay) addPassNameBtn_overlay.addEventListener('click', addPassManually_overlay); 
            if (passNameInput_overlay) passNameInput_overlay.addEventListener('keypress', (event) => { if (event.key === 'Enter') addPassManually_overlay(); });
            if (passFileInput_overlay) passFileInput_overlay.addEventListener('change', loadCustomPassesFromFile_overlay);
            if (savePassListBtn_overlay) savePassListBtn_overlay.addEventListener('click', saveCustomPassesToFile_overlay);
            if (clearCustomPassesBtn_overlay) clearCustomPassesBtn_overlay.addEventListener('click', confirmClearLoadedCustomPasses_overlay);
            
            document.querySelectorAll('.overlay-close-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const overlay = e.currentTarget.closest('.content-overlay');
                    if (overlay) { overlay.style.display = 'none'; checkAndCloseBodyOverlay(); }
                });
            });

            // Event Listeners for Custom Modals
            if (customAlertOkBtn) {
                customAlertOkBtn.addEventListener('click', () => {
                    if (customAlertModal) customAlertModal.style.display = 'none';
                    const parentToReopen = customAlertModal.dataset.parentOverlayId;
                    if (parentToReopen && document.getElementById(parentToReopen)) {
                        document.getElementById(parentToReopen).style.display = 'flex';
                        if (!document.body.classList.contains('overlay-open')) {
                             document.body.classList.add('overlay-open');
                        }
                    } else {
                        checkAndCloseBodyOverlay();
                    }
                    customAlertModal.removeAttribute('data-parent-overlay-id');
                });
            }
            if (customConfirmOkBtn) {
                customConfirmOkBtn.addEventListener('click', () => {
                    if (customConfirmModal) customConfirmModal.style.display = 'none';
                    const parentToReopen = customConfirmModal.dataset.parentOverlayId;
                    
                    if (typeof currentConfirmCallback === 'function') {
                        currentConfirmCallback();
                    }
                    currentConfirmCallback = null;
                    currentCancelCallback = null;

                    if (parentToReopen && document.getElementById(parentToReopen)) {
                        document.getElementById(parentToReopen).style.display = 'flex';
                        if (!document.body.classList.contains('overlay-open')) {
                             document.body.classList.add('overlay-open');
                        }
                    } else {
                        checkAndCloseBodyOverlay();
                    }
                    customConfirmModal.removeAttribute('data-parent-overlay-id');
                });
            }
            if (customConfirmCancelBtn) {
                customConfirmCancelBtn.addEventListener('click', () => {
                    if (customConfirmModal) customConfirmModal.style.display = 'none';
                    const parentToReopen = customConfirmModal.dataset.parentOverlayId;

                    if (typeof currentCancelCallback === 'function') {
                        currentCancelCallback();
                    }
                    currentConfirmCallback = null;
                    currentCancelCallback = null;

                    if (parentToReopen && document.getElementById(parentToReopen)) {
                        document.getElementById(parentToReopen).style.display = 'flex';
                        if (!document.body.classList.contains('overlay-open')) {
                             document.body.classList.add('overlay-open');
                        }
                    } else {
                        checkAndCloseBodyOverlay();
                    }
                    customConfirmModal.removeAttribute('data-parent-overlay-id');
                });
            }


            if (reopenOverlayBtn) reopenOverlayBtn.addEventListener('click', showResultOverlay);
            if (mainCopyBtn) mainCopyBtn.addEventListener('click', copyResultsToClipboard);
            if (overlayCopyBtn) overlayCopyBtn.addEventListener('click', copyResultsToClipboard);
            if (helpBtn) helpBtn.addEventListener('click', openHelpOverlay);
            if (shareBtn) shareBtn.addEventListener('click', openShareOverlay);
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
            
            setupSpeechRecognition(); 
            setupPassSpeechRecognition_overlay(); 
            setupPWAInstallation();
        });
        
        // --- Custom Alert & Confirm ---
        function showCustomAlert(message, title = "Meddelande", parentOverlayElement = null) {
            if (!customAlertModal || !customAlertTitle || !customAlertMessage || !customAlertHeader) {
                console.error("Custom alert DOM elements missing. Falling back to native alert.");
                alert((title ? title + "\n\n" : "") + message); // Fallback
                return;
            }
            customAlertTitle.textContent = title;
            customAlertMessage.innerHTML = message; 
            customAlertHeader.style.display = 'flex';

            if (parentOverlayElement && parentOverlayElement.id) {
                customAlertModal.dataset.parentOverlayId = parentOverlayElement.id;
                 if(parentOverlayElement) parentOverlayElement.style.display = 'none'; 
            } else {
                customAlertModal.removeAttribute('data-parent-overlay-id');
            }

            closeAllOverlays(customAlertModal); 

            customAlertModal.style.display = 'flex';
            if (!document.body.classList.contains('overlay-open')) { 
                 document.body.classList.add('overlay-open');
            }
            if(customAlertOkBtn) customAlertOkBtn.focus();
        }

        function showCustomConfirm(message, title = "Bekräfta åtgärd", onConfirm, onCancel, parentOverlayElement = null) {
            if (!customConfirmModal || !customConfirmTitle || !customConfirmMessage || !customConfirmOkBtn || !customConfirmCancelBtn || !customConfirmHeader) {
                console.error("Custom confirm DOM elements missing. Falling back to native confirm.");
                if (confirm((title ? title + "\n\n" : "") + message)) { // Fallback
                    if (onConfirm) onConfirm();
                } else {
                    if (onCancel) onCancel();
                }
                return;
            }
            customConfirmTitle.textContent = title;
            customConfirmMessage.innerHTML = message; 
            currentConfirmCallback = onConfirm;
            currentCancelCallback = onCancel;
            customConfirmHeader.style.display = 'flex';

            if (parentOverlayElement && parentOverlayElement.id) {
                customConfirmModal.dataset.parentOverlayId = parentOverlayElement.id;
                if(parentOverlayElement) parentOverlayElement.style.display = 'none'; 
            } else {
                customConfirmModal.removeAttribute('data-parent-overlay-id');
            }
            
            closeAllOverlays(customConfirmModal); 

            customConfirmModal.style.display = 'flex';
             if (!document.body.classList.contains('overlay-open')) { 
                document.body.classList.add('overlay-open');
            }
            if(customConfirmOkBtn) customConfirmOkBtn.focus();
        }


        function saveParticipantsToLocalStorage() { localStorage.setItem(PARTICIPANTS_KEY, JSON.stringify(participants)); }
        function saveCustomPassesToLocalStorage() { localStorage.setItem(CUSTOM_PASSES_KEY, JSON.stringify(customPasses)); }

        function initializeTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = button.dataset.tab;
                    activateTab(targetTabId); localStorage.setItem(LAST_ACTIVE_TAB_KEY, targetTabId);
                });
            });
            const lastActiveTab = localStorage.getItem(LAST_ACTIVE_TAB_KEY);
            activateTab(lastActiveTab && document.getElementById(lastActiveTab) ? lastActiveTab : 'participantsTab');
        }
        function activateTab(tabId) {
            tabContents.forEach(content => content.style.display = content.id === tabId ? 'flex' : 'none');
            tabButtons.forEach(button => button.classList.toggle('active', button.dataset.tab === tabId));
        }
        function setupSpeechRecognition() { 
             if (SpeechRecognition && speakNameBtn) {
                try {
                    recognition = new SpeechRecognition(); recognition.lang = 'sv-SE'; recognition.continuous = false; recognition.interimResults = false;
                    recognition.onresult = (event) => { 
                        const spokenName = event.results[0][0].transcript.trim();
                        if (addNameToParticipantsList(spokenName)) { saveParticipantsToLocalStorage(); renderNameList(); clearResults(); }
                    };
                    recognition.onerror = (e) => { console.error('Namn-röstfel:', e.error); if (speakNameBtn) { speakNameBtn.title = "Röstfel"; speakNameBtn.classList.remove('is-listening'); speakNameBtn.disabled = false; } };
                    recognition.onstart = () => { if (speakNameBtn) { speakNameBtn.classList.add('is-listening'); speakNameBtn.disabled = true; speakNameBtn.title = "Lyssnar..."; } };
                    recognition.onend = () => { if (speakNameBtn) { speakNameBtn.classList.remove('is-listening'); speakNameBtn.disabled = false; speakNameBtn.title = "Tala in passkytt"; } };
                    speakNameBtn.addEventListener('click', () => { try { if (recognition) recognition.start(); } catch (e) { console.error("Start namn-rec fel:", e); if (speakNameBtn) { speakNameBtn.classList.remove('is-listening'); speakNameBtn.disabled = false; speakNameBtn.title = "Tala in passkytt"; }} });
                } catch (e) { console.error("Init namn-SpeechRec fel:", e); if (speakNameBtn) { speakNameBtn.disabled = true; speakNameBtn.title = 'Röstfel.'; }}
            } else { if (speakNameBtn) { speakNameBtn.disabled = true; speakNameBtn.title = 'Röstinmatning stöds ej.'; }}
        }
        function setupPassSpeechRecognition_overlay() { 
            if (SpeechRecognition && speakPassNameBtn_overlay) {
                try {
                    passRecognition = new SpeechRecognition(); passRecognition.lang = 'sv-SE'; passRecognition.continuous = false; passRecognition.interimResults = false;
                    passRecognition.onresult = (event) => { addPassNameToList(event.results[0][0].transcript.trim()); }; 
                    passRecognition.onerror = (e) => { console.error('Pass-röstfel:', e.error); if (speakPassNameBtn_overlay) { speakPassNameBtn_overlay.title = "Röstfel"; speakPassNameBtn_overlay.classList.remove('is-listening'); speakPassNameBtn_overlay.disabled = false;} };
                    passRecognition.onstart = () => { if (speakPassNameBtn_overlay) { speakPassNameBtn_overlay.classList.add('is-listening'); speakPassNameBtn_overlay.disabled = true; speakPassNameBtn_overlay.title = "Lyssnar..."; }};
                    passRecognition.onend = () => { if (speakPassNameBtn_overlay) { speakPassNameBtn_overlay.classList.remove('is-listening'); speakPassNameBtn_overlay.disabled = false; speakPassNameBtn_overlay.title = "Tala in pass-ID"; }};
                    speakPassNameBtn_overlay.addEventListener('click', () => { try { if (passRecognition) passRecognition.start(); } catch (e) { console.error("Start pass-rec fel:", e); if (speakPassNameBtn_overlay) { speakPassNameBtn_overlay.classList.remove('is-listening'); speakPassNameBtn_overlay.disabled = false; speakPassNameBtn_overlay.title = "Tala in pass-ID";}} });
                } catch (e) { console.error("Init pass-SpeechRec fel:", e); if (speakPassNameBtn_overlay) { speakPassNameBtn_overlay.disabled = true; speakPassNameBtn_overlay.title = 'Röstfel.'; }}
            } else { if (speakPassNameBtn_overlay) { speakPassNameBtn_overlay.disabled = true; speakPassNameBtn_overlay.title = 'Röstinmatning stöds ej.'; }}
        }
        function setupPWAInstallation() {
             window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault(); deferredPrompt = e;
                if (installAppBtn) {
                    installAppBtn.style.display = 'inline-flex'; 
                    installAppBtn.onclick = async () => { 
                        if (deferredPrompt) {
                            deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null;
                            if (installAppBtn) installAppBtn.style.display = 'none';
                        } else { 
                            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                            if (isIOS) showCustomAlert("För iOS: Använd Dela-ikonen i Safari och välj 'Lägg till på hemskärmen'.", "Installationsguide");
                            else if (navigator.standalone || window.matchMedia('(display-mode: standalone)').matches) showCustomAlert("Appen är redan installerad!", "Information");
                            else showCustomAlert("Installationsprompt ej tillgänglig för tillfället. Försök igen senare eller följ webbläsarens anvisningar för att lägga till på hemskärmen.", "Information");
                        }
                    };
                }
            });
            window.addEventListener('appinstalled', () => { if (installAppBtn) installAppBtn.style.display = 'none'; deferredPrompt = null; });
        }
        function applyTheme(theme) {
            const newTheme = theme === 'dark' ? 'dark' : 'light'; 
            document.body.setAttribute('data-theme', newTheme);
            if (themeIconSun) themeIconSun.style.display = newTheme === 'dark' ? 'block' : 'none';
            if (themeIconMoon) themeIconMoon.style.display = newTheme === 'light' ? 'block' : 'none';
            localStorage.setItem('theme', newTheme);
            if (themeToggleBtn) themeToggleBtn.title = newTheme === 'dark' ? "Ljust tema" : "Mörkt tema";
            const metaThemeColor = document.querySelector("meta[name=theme-color]");
            if (metaThemeColor) metaThemeColor.setAttribute("content", getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim());
        }
        function toggleTheme() { currentTheme = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'; applyTheme(currentTheme); }
        
        function smartSortPasses(a,b){const nA=parseFloat(a),nB=parseFloat(b),aN=!isNaN(nA)&&isFinite(a),bN=!isNaN(nB)&&isFinite(b);return aN&&bN?nA-nB:aN?-1:bN?1:a.localeCompare(b,'sv',{numeric:!0,sensitivity:'base'})}

        function openAdvancedSettingsModal() {
            if (advancedSettingsOverlay) {
                closeAllOverlays(advancedSettingsOverlay); 
                advancedSettingsOverlay.style.display = 'flex';
                document.body.classList.add('overlay-open');
                updatePassDistributionConfigUI(); 
            }
        }
        function handlePassDistributionModeChange() {
            passDistributionConfigMode = passModeAdvancedRadio && passModeAdvancedRadio.checked ? 'advanced' : 'standard';
            localStorage.setItem(PASS_DISTRIBUTION_CONFIG_MODE_KEY, passDistributionConfigMode);
            updatePassDistributionConfigUI();
            clearResults(); 
        }
        function updatePassDistributionConfigUI() {
            if (passModeStandardRadio && passModeAdvancedRadio) {
                passModeStandardRadio.checked = passDistributionConfigMode === 'standard';
                passModeAdvancedRadio.checked = passDistributionConfigMode === 'advanced';
            }
            if (passDistributionTitle) passDistributionTitle.textContent = `Passfördelning (${passDistributionConfigMode==='advanced'?'Avancerad':'Standard'})`;
            if (customPassElementsContainer) {
                const isAdvanced = passDistributionConfigMode === 'advanced';
                customPassElementsContainer.style.display = isAdvanced ? 'block' : 'none'; 
                customPassElementsContainer.classList.toggle('disabled-look', !isAdvanced);
            }
            if (passDistributionMethodInfo) {
                if(passDistributionConfigMode==='standard'){passDistributionMethodInfo.textContent=participants.length>0?`Passkyttarna (${participants.length}st) fördelas över pass 1-${participants.length}.`:"Lägg till passkyttar.";}
                else{
			if(customPasses.length>0){
				if(participants.length<1){passDistributionMethodInfo.textContent="Lägg till passkyttar.";}
                     		else{passDistributionMethodInfo.textContent=`Passkyttarna (${participants.length}st) fördelas över de ${customPasses.length} specificerade passen.`+ (customPasses.length < participants.length ? ` (${participants.length - customPasses.length} blir oplacerade)` : '');}
			}
                        else{passDistributionMethodInfo.textContent="Avancerad vald, men inga pass definierade. Öppna ⚙️ för att lägga till pass.";}}
                	passDistributionMethodInfo.style.display = (participants.length > 0 || passDistributionConfigMode === 'advanced') ? 'block' : 'none';
            	}
            renderCustomPassListInOverlay_overlay(); 
            updateCustomPassesSummaryInOverlay_overlay(); 
        }
        function updateCustomPassesSummaryInOverlay_overlay() { 
            if (customPassesInfoInOverlay) { 
                 customPassesInfoInOverlay.textContent = customPasses.length > 0 ? `Egen lista: ${customPasses.length} pass.` : 'Inga egna pass tillagda.';
                 customPassesInfoInOverlay.style.display = 'block'; 
            }
        }
        function renderCustomPassListInOverlay_overlay() { 
            if (!customPassDisplayList_overlay || !noCustomPassesInfo_overlay) return;
            customPassDisplayList_overlay.innerHTML = '';
            noCustomPassesInfo_overlay.style.display = customPasses.length === 0 ? 'block' : 'none';
            customPasses.forEach((passId)=>{const li=document.createElement('li');li.textContent=passId;const del=document.createElement('button');del.classList.add('delete-btn','icon-button');del.title=`Ta bort ${passId}`;del.innerHTML='<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"/></svg>';del.onclick=()=>deleteCustomPassByValue_overlay(passId);li.appendChild(del);customPassDisplayList_overlay.appendChild(li);});
        }
        function addPassNameToList(passIdToAdd) { 
            const passId = passIdToAdd.trim(); if (!passId) return false; 
            if (customPasses.some(p => p.toLowerCase() === passId.toLowerCase())) { 
                showCustomAlert(`Pass-ID "${passId}" finns redan.`, "Dublett", advancedSettingsOverlay);
                return false; 
            }
            customPasses.push(passId); customPasses.sort(smartSortPasses); 
            saveCustomPassesToLocalStorage(); updatePassDistributionConfigUI(); clearResults(); return true;
        }
        function addPassManually_overlay() { 
            if (passNameInput_overlay && addPassNameToList(passNameInput_overlay.value.trim())) { passNameInput_overlay.value = ''; } 
            if (passNameInput_overlay) passNameInput_overlay.focus();
        }
        function deleteCustomPassByValue_overlay(passIdToDelete) {
            customPasses = customPasses.filter(p => p !== passIdToDelete);
            saveCustomPassesToLocalStorage(); updatePassDistributionConfigUI(); clearResults();
        }
        function loadCustomPassesFromFile_overlay(event) {
            const file = event.target.files[0];
            if (file && passFileInput_overlay) {
                const reader=new FileReader();reader.onload=(e)=>{
                    let added=0;
                    const currentLower=customPasses.map(p=>p.toLowerCase());
                    e.target.result.split(/\r\n|\n/).map(l=>l.trim()).filter(l=>l).forEach(nP=>{
                        if(!currentLower.includes(nP.toLowerCase())){
                            customPasses.push(nP);
                            added++;
                        }
                    });
                    if(added>0){
                        customPasses.sort(smartSortPasses);
                        saveCustomPassesToLocalStorage();
                        updatePassDistributionConfigUI();
                        clearResults();
                    } 
                    showCustomAlert(`${added} nya unika pass-ID tillagda.`, "Fil Inläst", advancedSettingsOverlay);
                    event.target.value='';
                };
                reader.readAsText(file);
            }
        }
        function saveCustomPassesToFile_overlay() {
            if(customPasses.length===0){ 
                showCustomAlert('Ingen lista med egna pass att spara.', "Information", advancedSettingsOverlay);
                return;
            }
            const txt=customPasses.join('\n');const blob=new Blob([txt],{type:'text/plain'});const a=document.createElement('a');a.download='passlista_egen.txt';a.href=URL.createObjectURL(blob);a.click();URL.revokeObjectURL(a.href);
        }
        function confirmClearLoadedCustomPasses_overlay() {
            showCustomConfirm("Är du säker på att du vill rensa hela listan med egna pass?", "Bekräfta Rensa", 
            () => { 
                customPasses = []; 
                if(passNameInput_overlay) passNameInput_overlay.value = ''; 
                saveCustomPassesToLocalStorage(); 
                updatePassDistributionConfigUI(); 
                clearResults(); 
            }, 
            null, 
            advancedSettingsOverlay
            );
        }
        function addNameToParticipantsList(nameToAdd) { 
            const name=nameToAdd.trim();
            if(!name) return false;
            if(participants.some(p=>p.toLowerCase()===name.toLowerCase())){
                showCustomAlert(`Passkytten "${name}" finns redan i listan.`, "Dublett");
                return false;
            }
            participants.push(name);
            return true; 
        }
        function updateParticipantsCount() { 
            if (participantsCountInfo) {
                participantsCountInfo.textContent = participants.length > 0 ? `(${participants.length} passkyttar)` : '';
                participantsCountInfo.style.display = participants.length > 0 ? 'block' : 'none';
            }
            updatePassDistributionConfigUI(); 
        }
        function renderNameList() {
            if (!nameList || !noNamesInfo) return; nameList.innerHTML = '';
            participants.sort((a,b)=>a.localeCompare(b,'sv',{sensitivity:'base'}));
            noNamesInfo.style.display=participants.length===0?'block':'none';
            participants.forEach(name=>{const li=document.createElement('li');li.textContent=name;const del=document.createElement('button');del.classList.add('delete-btn','icon-button');del.title=`Ta bort ${name}`;del.innerHTML='<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11H7v-2h10v2z"/></svg>';del.onclick=()=>deleteNameByValue(name);li.appendChild(del);nameList.appendChild(li);});
            updateParticipantsCount(); 
        }
        function deleteNameByValue(nameToDelete) { participants = participants.filter(p => p !== nameToDelete); saveParticipantsToLocalStorage(); renderNameList(); clearResults(); }
        function addName() { if (nameInput && addNameToParticipantsList(nameInput.value.trim())) { saveParticipantsToLocalStorage(); renderNameList(); clearResults(); nameInput.value = ''; } if (nameInput) nameInput.focus(); }
        
        function loadParticipantNamesFromFile(event) {
            const file=event.target.files[0];if(file&&fileInput){const reader=new FileReader();reader.onload=(e)=>{let added=0;e.target.result.split(/\r\n|\n/).forEach(line=>{if(addNameToParticipantsList(line.trim()))added++;});if(added>0){saveParticipantsToLocalStorage();renderNameList();clearResults();} 
            showCustomAlert(`${added} nya unika passkyttar tillagda från fil.`, "Fil Inläst");
            event.target.value='';};reader.readAsText(file);}
        }
        function saveParticipantNamesToFile() { 
            if(participants.length===0){ 
                showCustomAlert('Inga passkyttar att spara.', "Information");
                return;
            }
            const txt=participants.join('\n');const blob=new Blob([txt],{type:'text/plain'});const a=document.createElement('a');a.download='passkyttlista.txt';a.href=URL.createObjectURL(blob);a.click();URL.revokeObjectURL(a.href); 
        }
        
        function clearResults() {
            if(resultsList)resultsList.innerHTML='';if(overlayResultsList)overlayResultsList.innerHTML='';
            if(noResultsInfo){
                if(participants.length>0||(passDistributionConfigMode==='advanced'&&customPasses.length>0)){noResultsInfo.textContent="Klicka på \"Slumpa Pass\" för resultat.";}
                else if(participants.length>0 && passDistributionConfigMode==='advanced'&&customPasses.length===0){noResultsInfo.textContent="Lägg till egna pass i Passinställningar (⚙️) eller välj Standard.";}
                else{noResultsInfo.textContent="Lägg till passkyttar för att kunna fördela pass.";}
                noResultsInfo.style.display='block';
            }
            if(unassignedParticipantsList)unassignedParticipantsList.style.display='none';
            if(overlayUnassignedParticipants)overlayUnassignedParticipants.style.display='none';
            if(mainResultActionsTop)mainResultActionsTop.style.display='none';
            if(overlayCopyBtn)overlayCopyBtn.style.display='none';
            if(resultOverlay&&resultOverlay.style.display==='flex'){resultOverlay.style.display='none';checkAndCloseBodyOverlay();}
        }
        function shuffleArray(arr){const newArr=[...arr];for(let i=newArr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[newArr[i],newArr[j]]=[newArr[j],newArr[i]];}return newArr}
        
        function randomizePasses() {
            if(participants.length===0){ 
                showCustomAlert('Lägg till passkyttar först!', "Information");
                return;
            }
            if(passDistributionConfigMode==='advanced'&&customPasses.length===0){
                showCustomAlert('Avancerad passfördelning är vald, men inga egna pass har lagts till.<br>Öppna Passinställningar (⚙️) för att lägga till pass eller välj Standardnumrering.', "Information");
                openAdvancedSettingsModal();
                return;
            }
            if(passDistributionConfigMode==='advanced'&&customPasses.length<participants.length) {
                 showCustomConfirm(
                    `Det finns ${customPasses.length} egna pass men ${participants.length} passkyttar.<br>Detta innebär att ${participants.length-customPasses.length} skytt(ar) kommer att bli oplacerade.<br><br>Vill du fortsätta ändå?`, 
                    "Varning: Antal Pass",
                    () => { // onConfirm
                        proceedWithRandomization();
                    } 
                 );
            } else {
                proceedWithRandomization();
            }
        }

        function proceedWithRandomization() {
            clearResults();if(noResultsInfo)noResultsInfo.style.display='none';
            const shuffled=shuffleArray(participants);let unassigned=[];const items=[];
            const createLi=(id,p)=>{const li=document.createElement('li');li.innerHTML=`<span>${id}:</span> ${p}`;return li;};
            if(passDistributionConfigMode==='advanced'){const avail=[...shuffled];customPasses.forEach(pID=>items.push(createLi(pID,avail.length>0?avail.shift():"<i>Ledigt</i>")));unassigned=avail;}
            else{shuffled.forEach((name,i)=>items.push(createLi(`Pass ${i+1}`,name)));}
            items.forEach(item=>{if(resultsList)resultsList.appendChild(item.cloneNode(!0));if(overlayResultsList)overlayResultsList.appendChild(item);});
            if(unassigned.length>0){const txt=`<strong>Oplacerade (${unassigned.length}):</strong> ${unassigned.join(', ')}`;if(unassignedParticipantsList){unassignedParticipantsList.innerHTML=txt;unassignedParticipantsList.style.display='block';}if(overlayUnassignedParticipants){overlayUnassignedParticipants.innerHTML=txt;overlayUnassignedParticipants.style.display='block';}}
            else{if(unassignedParticipantsList)unassignedParticipantsList.style.display='none';if(overlayUnassignedParticipants)overlayUnassignedParticipants.style.display='none';}
            if(items.length>0){if(mainResultActionsTop)mainResultActionsTop.style.display='flex';if(overlayCopyBtn)overlayCopyBtn.style.display='inline-flex';}showResultOverlay();
        }


        function showResultOverlay(){if(resultOverlay&&((resultsList&&resultsList.hasChildNodes())||(overlayResultsList&&overlayResultsList.hasChildNodes()))){closeAllOverlays(resultOverlay);resultOverlay.style.display='flex';document.body.classList.add('overlay-open');}}
        function openHelpOverlay(){
            if(helpOverlay){
                const helpContent = helpOverlay.querySelector('.overlay-scrollable-content');
                if(helpContent) helpContent.scrollTop = 0; 
                closeAllOverlays(helpOverlay);
                helpOverlay.style.display='flex';
                document.body.classList.add('overlay-open');
            }
        }
        function openShareOverlay(){if(shareOverlay){closeAllOverlays(shareOverlay);generateQRCode();shareOverlay.style.display='flex';document.body.classList.add('overlay-open');}}
        
        function closeAllOverlays(keepOpenOverlay = null) {
            document.querySelectorAll('.content-overlay').forEach(o => {
                if (o && o !== keepOpenOverlay) { 
                     o.style.display = 'none';
                }
            });
        }

        function checkAndCloseBodyOverlay(){
            const isOpen=Array.from(document.querySelectorAll('.content-overlay')).some(o=>o.style.display==='flex');
            if(!isOpen&&document.body.classList.contains('overlay-open'))document.body.classList.remove('overlay-open');
             else if (isOpen && !document.body.classList.contains('overlay-open')) {
                document.body.classList.add('overlay-open');
            }
        }
        function generateQRCode(){if(!qrCodeContainer||typeof QRious==='undefined')return;qrCodeContainer.innerHTML='';const canvas=document.createElement('canvas');try{let size=qrCodeContainer.offsetWidth>0?Math.min(180,qrCodeContainer.offsetWidth-20):180;new QRious({element:canvas,value:appURL,size:size,padding:5,level:'H',background:'white',foreground:'black'});if(canvas.width>0)qrCodeContainer.appendChild(canvas);}catch(e){console.error("QR fel:",e);}if(shareableLink){shareableLink.href=appURL;shareableLink.textContent=appURL;}}
        
        function copyResultsToClipboard(){
            const list=resultsList;
            if(!list||list.children.length===0){ 
                showCustomAlert('Inga resultat att kopiera.', "Information");
                return;
            }
            let txt=`${passDistributionTitle.textContent}:\n`;Array.from(list.children).forEach(li=>txt+=li.textContent.replace(/<\/?i>/g,'')+'\n');
            if(unassignedParticipantsList&&unassignedParticipantsList.style.display==='block'&&unassignedParticipantsList.textContent){
                const div=document.createElement('div');div.innerHTML=unassignedParticipantsList.innerHTML;txt+=`\n${div.textContent||div.innerText||""}\n`;
            }
            if(navigator.clipboard&&navigator.clipboard.writeText){
                navigator.clipboard.writeText(txt.trim()).then(()=> showCustomAlert('Resultat kopierade till urklipp!', "Kopierat")).catch(()=> showCustomAlert('Kopiering misslyckades.', "Fel"));
            } else {
                const ta=document.createElement("textarea");ta.value=txt.trim();document.body.appendChild(ta);ta.select();
                try{document.execCommand('copy'); showCustomAlert('Resultat kopierade! (fallback)', "Kopierat");}
                catch(e){ showCustomAlert('Kopiering misslyckades (fallback).', "Fel");}
                document.body.removeChild(ta);
            }
        }
    </script>
</body>
</html>